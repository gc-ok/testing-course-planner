<style>
  /* --- SCOPED CSS (Safe for Finalsite) --- */
  #mhs-app-root { font-family: 'Roboto', sans-serif; background: #fff; color: #333; min-height: 800px; display: flex; flex-direction: column; position: relative; max-width: 1200px; margin: 0 auto; }
  
  /* Utils */
  #mhs-app-root .hidden { display: none !important; }
  #mhs-app-root .view-section { display: none; animation: mhsFadeIn 0.4s; }
  #mhs-app-root .view-section.active { display: block; }
  @keyframes mhsFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Layout */
  #mhs-app-root .header { padding: 15px 0; border-bottom: 4px solid #D21F28; margin-bottom: 20px; }
  #mhs-app-root .title { color: #D21F28; font-size: 26px; font-weight: 700; line-height: 1.2; }
  
  /* Components */
  #mhs-app-root .btn { padding: 12px 24px; font-weight: 700; border: none; border-radius: 4px; cursor: pointer; display:inline-block; margin:5px; transition: 0.2s; }
  #mhs-app-root .btn-red { background: #D21F28; color: white; }
  #mhs-app-root .btn-red:hover { background: #a0181f; }
  #mhs-app-root .btn-outline { background: white; color: #D21F28; border: 2px solid #D21F28; }
  #mhs-app-root .btn-sm { padding: 4px 8px; font-size: 11px; border: 1px solid #ddd; background: white; border-radius: 3px; cursor: pointer; }
  #mhs-app-root .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white; transition: 0.2s; margin-bottom:15px; }
  #mhs-app-root .card:hover { border-color: #D21F28; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  
  /* Grid & Columns */
  #mhs-app-root .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }
  #mhs-app-root .shop-cols { display: flex; gap: 20px; align-items: flex-start; }
  #mhs-app-root .col-left { flex: 0 0 320px; width: 100%; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
  #mhs-app-root .col-right { flex: 1; min-width: 0; }
  
  /* Slots */
  #mhs-app-root .slot { border-bottom: 1px solid #eee; font-size: 13px; }
  #mhs-app-root .slot.fill { background: #f9fff9; border-left: 3px solid #28a745; }
  #mhs-app-root .del { color: #c00; cursor: pointer; font-weight: bold; font-size: 16px; padding: 0 8px; }
  
  /* Forms */
  #mhs-app-root select, #mhs-app-root input[type=text] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; }
  #mhs-app-root label { font-weight: bold; font-size: 12px; display: block; margin-bottom: 4px; }
  #mhs-app-root .guide { background: #e3f2fd; color: #0d47a1; padding: 15px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3; font-size: 14px; }
  #mhs-app-root .guide.warn { background: #fff3cd; color: #856404; border-color: #ffc107; }

  /* Modal Overlay */
  #mhs-app-root .modal-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
  #mhs-app-root .modal { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

  /* --- MOBILE OPTIMIZATIONS --- */
  @media (max-width: 768px) {
    #mhs-app-root .shop-cols { flex-direction: column; }
    #mhs-app-root .col-left { flex: 1 1 100%; width: 100%; max-width: none; margin-bottom: 20px; }
    #mhs-app-root .modal { width: 95% !important; margin: 10px; max-height: 90vh; overflow-y: auto; }
  }
  
  /* --- PRINT FIX (COLLAPSE HEIGHT) --- */
  @media print {
    /* 1. Reset Body & Main Container */
    body, html, #mhs-app-root { 
      background: white; 
      height: auto !important; 
      min-height: 0 !important;
      overflow: visible !important;
    }
    
    /* 2. Hide specific heavy elements so they don't take up space */
    .header, .view-section, #mhs-loader, #swapModal, #msgModal {
      display: none !important;
    }

    /* 3. Ensure the receipt modal is visible and positioned at the top */
    #finishModal { 
      display: block !important; 
      position: absolute !important; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: auto; 
      z-index: 99999;
      background: white;
    }

    /* 4. Style the modal content for print */
    .modal {
      box-shadow: none !important; 
      border: none !important; 
      width: 100% !important; 
      max-width: 100% !important; 
      padding: 0 !important;
      margin: 0 !important;
    }
    
    /* 5. Hide buttons inside the modal */
    .modal button { display: none !important; }
  }


  /* --- CARD COLLAPSE STYLES --- */
  .desc-box {
      max-height: 100px; /* Only show the first ~5 lines */
      overflow: hidden;
      position: relative;
      transition: max-height 0.5s ease; /* Smooth animation */
      margin-bottom: 10px;
  }
  
  /* The fade-out effect at the bottom */
  .desc-box::after {
      content: "";
      position: absolute;
      bottom: 0; left: 0; width: 100%;
      height: 60px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
      pointer-events: none;
      transition: opacity 0.3s;
  }

  /* When expanded, remove the limit and the fade */
  .desc-box.expanded {
      max-height: 2000px; /* Arbitrary large number to allow full expansion */
  }
  .desc-box.expanded::after {
      opacity: 0;
  }

  /* The link style for "Read More" */
  .toggle-link {
      background: none;
      border: none;
      color: #007bff;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      display: inline-block;
      margin-bottom: 15px;
  }

  /* --- CLEANER CART STYLES --- */
  .cart-item {
      padding: 12px 15px; /* More breathing room */
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between; /* Push button to the right */
      align-items: center; /* Vertically center everything */
      background: white;
      transition: background 0.2s;
  }
  .cart-item:hover {
      background: #fafafa;
  }
  .cart-item:last-child {
      border-bottom: none;
  }
  
  /* The small label (e.g. "CORE 1") */
  .cart-label {
      display: block;
      font-size: 10px;
      color: #999;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
  }
  
  /* The Course Title */
  .cart-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      line-height: 1.2;
  }
  
  /* Split Core Header */
  .split-header {
      background: #e3f2fd;
      color: #1565c0;
      font-size: 10px;
      font-weight: bold;
      padding: 6px 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-top: 1px solid #eee;
  }

  /* Empty Slot Styling */
  .slot-empty {
      padding: 15px;
      color: #aaa;
      font-size: 13px;
      font-style: italic;
      background-image: linear-gradient(45deg, #fdfdfd 25%, #f4f4f4 25%, #f4f4f4 50%, #fdfdfd 50%, #fdfdfd 75%, #f4f4f4 75%, #f4f4f4 100%);
      background-size: 20px 20px;
      border-bottom: 1px solid #eee;
  }

  /* --- NEW TAB NAVIGATION STYLES --- */
  .tab-group {
      display: flex;
      background: #f1f3f5; /* Light gray background container */
      padding: 5px;
      border-radius: 8px;
      margin-bottom: 20px;
      gap: 5px;
  }
  
  .tab-cat {
      flex: 1; /* Forces all 3 buttons to be equal width */
      text-align: center;
      padding: 12px 5px; /* Nice big click area */
      font-size: 13px;
      font-weight: 700;
      color: #666;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
  }
  
  .tab-cat:hover {
      background: rgba(0,0,0,0.05);
      color: #333;
  }
  
  /* The "Active" state pops out as white */
  .tab-cat.active {
      background: white !important;
      color: #D21F28 !important; /* School Red */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  /* --- STICKY SIDEBAR (FIXED HEIGHT) --- */
  #mhs-app-root .col-left { 
      position: sticky; 
      top: 20px; 
      align-self: start; 
      z-index: 100; 
      
      /* FIX: Use 75vh instead of 100vh. 
         This leaves room for the school website header above the tool 
         so the bottom button doesn't get pushed off screen. */
      max-height: 75vh; 
      
      /* Internal scrolling */
      overflow-y: auto; 
      
      /* Add breathing room at the bottom so the button isn't tight to the edge */
      padding-bottom: 30px; 
  }

  /* Disable sticky on mobile */
  @media (max-width: 768px) {
      #mhs-app-root .col-left { 
          position: static; 
          max-height: none; 
          overflow-y: visible; 
      }
  }
  
  /* --- UPDATED TOUR STYLES --- */
  #mhs-app-root .tour-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7); z-index: 9998;
    display: none; opacity: 0; transition: opacity 0.3s;
  }
  
  /* FIX: Only add white background if it's NOT a button (prevents red button from turning white) */
  #mhs-app-root .tour-active-element {
    position: relative; z-index: 9999 !important;
    box-shadow: 0 0 0 4px #D21F28, 0 0 20px rgba(0,0,0,0.5);
    border-radius: 4px;
    pointer-events: none;
  }
  /* Only give background to containers, not buttons */
  #mhs-app-root .tour-active-element:not(.btn) {
      background: white; 
  }

  #mhs-app-root .tour-tooltip {
    position: absolute; width: 300px; background: white; z-index: 10000;
    padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: none; animation: tourPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #mhs-app-root .tour-tooltip::after {
    content: ''; position: absolute; top: -8px; left: 20px;
    border-width: 0 8px 8px; border-style: solid; border-color: transparent transparent #fff transparent;
  }
  #mhs-app-root .tour-header { font-weight: 900; color: #D21F28; font-size: 16px; margin-bottom: 8px; text-transform: uppercase; }
  #mhs-app-root .tour-body { font-size: 13px; line-height: 1.5; color: #444; margin-bottom: 15px; white-space: pre-wrap; }
  #mhs-app-root .tour-footer { display: flex; justify-content: flex-end; gap: 8px; }
  
  /* FIX: Force colors for tour buttons so they aren't invisible */
  #mhs-app-root .tour-footer .btn-red { background: #D21F28 !important; color: white !important; }
  #mhs-app-root .tour-footer .btn-sm { border: 1px solid #ddd; }
  
</style>

<div id="mhs-app-root">

  <div id="mhs-loader" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:50; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <h3 style="color:#D21F28">Loading Course Catalog...</h3>
    <p style="color:#666; font-size:12px;">Connecting to database file...</p>
  </div>

  <div class="header">
    <div class="title">Mustang High School</div>
    <div style="font-size:13px; color:#666;">Course Pathway Planner</div>
  </div>

  <div class="main">

    <div id="view-welcome" class="view-section">
      <div class="card" style="text-align:center; padding:40px; border-top: 5px solid #D21F28;">
        <h2 style="color:#D21F28; margin-bottom:15px;">Welcome, Bronco!</h2>
        <p style="max-width:600px; margin:0 auto 30px auto; color:#555;">
          Plan your 2026-2027 schedule here before entering it into PowerSchool.
          <br><strong>Goal:</strong> Select 7 Classes and 2 Alternates.
        </p>
        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
          <button class="btn btn-red" id="btn-know-path">I Know My Pathway</button>
          <button class="btn btn-outline" id="btn-explore-path">Explore Pathways</button>
        </div>
      </div>
    </div>

    <div id="view-explore" class="view-section">
      <button class="btn-sm" id="btn-back-explore">‚Üê Back</button>
      <h2 style="color:#D21F28; text-align:center; margin:10px 0;">Career Pathways</h2>
      <div id="cardGrid" class="grid"></div>
    </div>

    <div id="view-form" class="view-section">
      <button class="btn-sm" id="btn-back-home" style="margin-bottom:15px;">‚Üê Back to Home</button>
      
      <div style="max-width:500px; margin:0 auto;" class="card">
        <h3 style="color:#D21F28; margin-bottom:15px; margin-top:0;">Student Profile</h3>
        
        <div style="display:flex; gap:10px;">
          <div style="flex:1;">
              <label>First Name <span style="color:red">*</span></label>
              <input type="text" id="inputFName" placeholder="John">
          </div>
          <div style="flex:1;">
              <label>Last Name <span style="color:red">*</span></label>
              <input type="text" id="inputLName" placeholder="Doe">
          </div>
        </div>

        <label>Student ID # <span style="color:red">*</span></label>
        <input type="text" id="inputID" placeholder="12345" inputmode="numeric">
  
        <label>Grade Level Next Year: <span style="color:red">*</span></label>
        <select id="gradeSelect">
          <option value="" disabled selected>Select Grade</option>
          <option value="9">Freshman (9th)</option>
          <option value="10">Sophomore (10th)</option>
          <option value="11">Junior (11th)</option>
          <option value="12">Senior (12th)</option>
        </select>
        
        <label>My Pathway: <span style="color:red">*</span></label>
        <select id="pathwaySelect"><option value="">-- Select Pathway --</option></select>
        
        <div style="font-size:11px; color:#666; margin:15px 0; background:#f9f9f9; padding:10px; border-left:3px solid #ccc;">
          <strong>Privacy Notice:</strong> Your selections are recorded for schedule building.
        </div>
  
        <button id="startBtn" class="btn btn-red" style="width:100%">Start Building</button>
      </div>
    </div>
    <div id="view-shopping" class="view-section">
    <button class="btn-sm" id="btn-back-profile" style="margin-bottom:10px;">‚Üê Back to Profile</button>

    <div class="shop-cols">
      
      <div class="col-left">
        <div style="background:#333; color:white; padding:15px; border-radius:8px 8px 0 0;">
          <h4 id="studentHeader" style="margin:0;">My Schedule</h4>
          <div style="font-size:11px; opacity:0.8; margin-top:5px;">Credits: <span id="slotCount">0</span>/7</div>
        </div>
        
        <div id="coreSlots"></div>
        <div id="flexSlots"></div>
        
        <div style="background:#f4f4f4; padding:10px; border-top:2px solid #ddd;">
          <div style="font-size:10px; font-weight:bold; color:#666; margin-bottom:5px;">ALTERNATES (2 Required)</div>
          <div id="altSlots"></div>
        </div>
        
        <div style="padding:15px; background:#fff; border-top:1px solid #eee; font-size:11px; color:#555; line-height:1.4;">
            
            <p style="margin-top:0; margin-bottom:10px;">
                <strong>Accelerated/AP Enrollment:</strong> Eligibility criteria apply; counselor verification is required prior to selection. These courses involve increased rigor and time commitments. Per district policy, no schedule changes or drops will be allowed after the first 8 days of the semester.
            </p>
            
            <p style="margin:0; padding-top:10px; border-top:1px dashed #ddd;">
                <strong>Selection Notice & Privacy:</strong> This selection process is a request and does not guarantee enrollment into the course. All data submitted (Name, ID, Course Selections, etc.) is recorded and stored for the purpose of schedule building by the Counseling Department.
            </p>
            
        </div>
        <div style="padding:15px;">
          <button class="btn btn-red" style="width:100%" id="btn-finish">Review & Submit</button>
        </div>
      </div>
      <div class="col-right">


        <div id="senior-alert" style="display:none; margin-bottom:15px; background:#ffebee; border:2px solid #D21F28; padding:15px; border-radius:6px; text-align:center;">
            <h4 style="color:#D21F28; margin:0 0 5px 0; font-size:16px; font-weight:900; text-transform:uppercase;">Attention Seniors</h4>
            <div style="font-weight:bold; color:#b71c1c; margin-bottom:5px;">
                Your course requests must be done ON PAPER due to being on old graduation requirements.
            </div>
            <div style="font-size:12px; color:#333;">
                You are welcome to browse electives here, but please use your official paper form for submission.
            </div>
        </div>
        <div style="margin-bottom:15px; background:#fff; border:1px solid #ddd; padding:12px; border-radius:6px; font-size:12px; color:#555; line-height:1.4;">
            <strong>How to choose electives:</strong>
            <ul style="margin:5px 0 0 0; padding-left:20px;">
                <li>Click the tabs below to switch between elective categories (Note that your REQUIRED core classes are already pre-populated and you can swap or change those out). </li>
            </ul>
        </div>
        
        <div class="tab-group">
          <button class="tab-cat active" data-type="pathway">My Pathway</button>
          <button class="tab-cat" data-type="required">Required</button>
          <button class="tab-cat" data-type="general">General</button>
        </div>

        <div id="guidanceBox" class="guide">Loading...</div>
        <div id="catalogList" class="grid" style="grid-template-columns:1fr;"></div>
      </div>

      
    </div>
  </div>


    
  </div> <div id="swapModal" class="modal-bg">
    <div class="modal">
      <h3>Swap Core Level</h3>
      <p>Move: <span id="swapSourceLabel" style="color:#007bff; font-weight:bold;"></span></p>
      <select id="swapTargetSelect"></select>
      <div style="text-align:right; margin-top:15px;">
        <button class="btn-sm" id="btn-cancel-swap">Cancel</button>
        <button class="btn-sm" style="background:#007bff; color:white;" id="btn-confirm-swap">Confirm</button>
      </div>
    </div>
  </div>

<div id="finishModal" class="modal-bg" style="z-index: 10000;">
  <div class="modal" style="width:600px; max-width:95%;">
    
    <div id="receipt-content">
      <div style="text-align:center; border-bottom:2px solid #D21F28; padding-bottom:10px; margin-bottom:15px;">
        <h2 style="color:#D21F28; margin:0;">Submission Complete</h2>
        <p style="color:#28a745; font-weight:bold; font-size:14px; margin-top:5px;">‚úì Data sent to Counseling Office</p>
      </div>

      <div style="background:#f8f9fa; padding:15px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px;">
        <h4 style="margin-top:0; border-bottom:1px solid #ccc; padding-bottom:5px;">Student Record</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:13px;">
          <div><strong>Name:</strong> <span id="receipt-name"></span></div>
          <div><strong>ID:</strong> <span id="receipt-id"></span></div>
          <div><strong>Grade:</strong> <span id="receipt-grade"></span></div>
          <div><strong>Pathway:</strong> <span id="receipt-path"></span></div>
        </div>
      </div>

      <h4 style="font-size:14px; margin-bottom:5px;">Selected Courses</h4>
      <div id="receipt-list" style="font-size:12px; line-height:1.6; border:1px solid #eee; padding:10px; margin-bottom:15px;">
        </div>
    </div>

    <div style="background:#fff3cd; color:#856404; padding:10px; font-size:12px; margin-bottom:15px; border-left:4px solid #ffc107;">
      <strong>‚ö† IMPORTANT:</strong> Please save this for your records. You cannot log back in to view this later.
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn-sm" onclick="document.getElementById('finishModal').style.display='none'">Close</button>
      <button class="btn btn-red" onclick="printReceipt()">üñ® Print / Save as PDF</button>
    </div>

  </div>
</div>

<div id="msgModal" class="modal-bg" style="z-index: 11000;">
  <div class="modal" style="width:400px; max-width:90%;">
    <h3 id="msgTitle" style="color:#D21F28; margin-top:0;">Alert</h3>
    <p id="msgBody" style="font-size:14px; color:#555; line-height:1.5;"></p>
    <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button id="msgCancelBtn" class="btn-sm">Cancel</button>
      <button id="msgOkBtn" class="btn btn-red" style="padding:6px 15px;">OK</button>
    </div>
  </div>
</div>
  
</div>

<script>

  // --- TOUR GUIDE CLASS (Paste before main script) ---
class TourGuide {
  constructor(steps) {
    this.steps = steps;
    this.currentStep = 0;
    this.overlay = null;
    this.tooltip = null;
  }

  init() {
    // Create UI Elements
    if (!document.getElementById('tour-overlay')) {
      const root = document.getElementById('mhs-app-root');
      
      this.overlay = document.createElement('div');
      this.overlay.className = 'tour-overlay';
      this.overlay.id = 'tour-overlay';
      root.appendChild(this.overlay);

      this.tooltip = document.createElement('div');
      this.tooltip.className = 'tour-tooltip';
      this.tooltip.innerHTML = `
        <div class="tour-header" id="tour-title"></div>
        <div class="tour-body" id="tour-text"></div>
        <div class="tour-footer">
           <button class="btn-sm" id="tour-skip">Skip</button>
           <button class="btn btn-red btn-sm" id="tour-next">Next</button>
        </div>
      `;
      root.appendChild(this.tooltip);

      // Bind Events
      document.getElementById('tour-next').onclick = () => this.next();
      document.getElementById('tour-skip').onclick = () => this.end();
    } else {
      this.overlay = document.getElementById('tour-overlay');
      this.tooltip = document.querySelector('.tour-tooltip');
    }
  }

  start() {
    this.init();
    this.currentStep = 0;
    this.overlay.style.display = 'block';
    setTimeout(() => this.overlay.style.opacity = '1', 10);
    this.showStep();
  }

  showStep() {
    const step = this.steps[this.currentStep];
    const target = document.querySelector(step.target);

    // Reset previous highlights
    document.querySelectorAll('.tour-active-element').forEach(el => el.classList.remove('tour-active-element'));
    this.tooltip.style.display = 'none';

    if (!target) {
        console.warn('Tour target missing:', step.target);
        this.next(); 
        return; 
    }

    // Scroll to target
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Highlight Target
    target.classList.add('tour-active-element');

    // Update Content
    document.getElementById('tour-title').innerText = step.title;
    document.getElementById('tour-text').innerText = step.text;
    document.getElementById('tour-next').innerText = (this.currentStep === this.steps.length - 1) ? 'Finish' : 'Next ‚Üí';

    // Position Tooltip (Basic Logic)
    setTimeout(() => {
        const rect = target.getBoundingClientRect();
        const rootRect = document.getElementById('mhs-app-root').getBoundingClientRect();
        
        let top = (rect.bottom - rootRect.top) + 15;
        let left = (rect.left - rootRect.left);

        // Edge check (keep inside container)
        if (left + 300 > rootRect.width) left = rootRect.width - 320;
        if (left < 0) left = 10;

        this.tooltip.style.top = top + 'px';
        this.tooltip.style.left = left + 'px';
        this.tooltip.style.display = 'block';
    }, 400); // Wait for scroll
  }

  next() {
    this.currentStep++;
    if (this.currentStep >= this.steps.length) {
      this.end();
    } else {
      this.showStep();
    }
  }

  end() {
    this.overlay.style.opacity = '0';
    this.tooltip.style.display = 'none';
    document.querySelectorAll('.tour-active-element').forEach(el => el.classList.remove('tour-active-element'));
    setTimeout(() => {
        this.overlay.style.display = 'none';
        // Optional: Save to localStorage so it doesn't show again
        // localStorage.setItem('mhs_tour_seen', 'true'); 
    }, 300);
  }
}
  
(function() {
  // ===============================================
  //  CONFIG: PASTE YOUR UPLOADED FILE LINK BELOW
  // ===============================================
  
  const DATA_FILE_URL = "./Finalsite_Course_Data.txt";

  // ===============================================

  // Global State (Wrapped in IIFE to be safe)
  let schoolData = {};
  let userState = { grade: null, pathway: null, cart: { core: [], electives: [], alternates: [] } };
  let pendingCourseSwap = { coreIndex: null, subIndex: null };
  
  // --- HARDCODED CURRICULUM DATA (FROM CODE.GS) ---
  const ALLOWED_SWAPS = {
    "9": {
        "English": ["English I", "English I Accelerated"],
        "History": ["Oklahoma History", "Oklahoma History Accelerated"],
        "Science": ["Physical Science", "Biology Accelerated"],
        "Math": ["Algebra I", "Algebra I Accelerated", "Geometry", "Geometry Accelerated"]
    },
    "10": {
        "English": ["English II", "English II Accelerated"],
        "History": ["World History", "AP World History"], 
        "Science": ["Biology", "Biology Accelerated", "Chemistry", "Chemistry Accelerated", "Physics"],
        "Math": ["Geometry", "Geometry Accelerated", "Algebra II", "Algebra II Accelerated", "STEM Algebra II Accelerated"]
    },
    "11": {
        "English": ["English III", "AP English Language & Composition"],
        "History": ["US History", "AP US History"],
        "Math": ["Algebra II", "Algebra II Accelerated", "STEM Algebra II Accelerated", "Intermediate Algebra", "PreCalculus Accelerated", "Algebra III", "Business Math", "AP PreCalculus", "AP Calculus AB", "AP Calculus BC", "Sports Statistics and Probability", "AP Statistics"],
        "Science": ["Physical Science", "Chemistry", "Chemistry Accelerated", "Chemistry II", "AP Chemistry", "Physics", "AP Physics I", "AP Physics II", "STEM Physics Accelerated", "Zoology", "Zoology II", "Forensic Science", "Anatomy & Physiology", "AP Biology", "Environmental Science and Natural Resources", "AP Environmental Science", "Earth and Space Science"]
    },
    "12": {
        "English": ["English IV", "AP English Literature & Composition"],
        "History": ["American Government", "AP US Government and Politics"],
        "Math": ["Algebra II", "Algebra II Accelerated", "STEM Algebra II Accelerated", "Intermediate Algebra", "PreCalculus Accelerated", "Algebra III", "Business Math", "AP PreCalculus", "AP Calculus AB", "AP Calculus BC", "Sports Statistics and Probability", "AP Statistics"],
        "Science": ["Physical Science", "Chemistry", "Chemistry Accelerated", "Chemistry II", "AP Chemistry", "Physics", "AP Physics I", "AP Physics II", "STEM Physics Accelerated", "Zoology", "Zoology II", "Forensic Science", "Anatomy & Physiology", "AP Biology", "Environmental Science and Natural Resources", "AP Environmental Science", "Earth and Space Science"]
    }
  };
  
  // ===============================================
  //  CONFIG: GOOGLE FORM INTEGRATION
  // ===============================================
  
  // 1. Create a Google Form with these Short Answer questions:
  //    - First Name
  //    - Last Name
  //    - Student ID
  //    - Schedule JSON (Make this a "Paragraph" question to hold the data)
  
  // 2. Get the URL that ends in /formResponse (Inspect your form to find this)
  const GOOGLE_FORM_URL = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSfLJcVHl8nMtnC9LUYlimfpjJ0T2UyV-me8Iv_y96tB2CTFog/formResponse";

  // 3. Get the "entry.xxxxxx" IDs for each question (See instructions below code)
  const FORM_FIELDS = {
      firstName: "entry.2022705835",  // Replace with actual ID
      lastName:  "entry.1204697517",
      studentId: "entry.823979582",
      jsonData:  "entry.1979462889"   // The paragraph question for the data blob
  };


  // Wait for HTML to exist before running
  document.addEventListener("DOMContentLoaded", function() {
      initApp();
  });
  
  // Fallback if DOMContentLoaded already fired (common in CMS)
  if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(initApp, 100);
  }

  function initApp() {
      const root = document.getElementById('mhs-app-root');
      if (!root) return;

      // 1. Navigation Buttons (Now includes the Back Button fix)
      document.getElementById('btn-know-path').onclick = function() { showView('view-form'); };
      document.getElementById('btn-explore-path').onclick = function() { showView('view-explore'); };
      document.getElementById('btn-back-explore').onclick = function() { showView('view-welcome'); };
      
      // FIX: Bind the new ID here instead of inline HTML
      document.getElementById('btn-back-home').onclick = function() { showView('view-welcome'); }; 
      document.getElementById('btn-back-profile').onclick = function() { showView('view-form'); };
      
      // 2. Form Inputs (We removed the 'checkReady' listeners)
      document.getElementById('inputID').addEventListener('input', function(e) {
          // This Regex replaces anything that isn't a digit (\D) with nothing
          this.value = this.value.replace(/\D/g, '');
      });
      // 3. Action Buttons
      document.getElementById('startBtn').onclick = initShopping; // This now handles validation
      document.getElementById('btn-finish').onclick = finishSchedule;
      
      // 4. Modal Buttons
      document.getElementById('btn-cancel-swap').onclick = function() { document.getElementById('swapModal').style.display = 'none'; };
      document.getElementById('btn-confirm-swap').onclick = confirmCourseSwap;
      
      // 5. Catalog Tabs
      document.querySelectorAll('.tab-cat').forEach(btn => {
          btn.onclick = function() { renderCatalog(this.dataset.type, this); };
      });

      // 6. Data Loading
      if(DATA_FILE_URL.includes("REPLACE")) {
         console.error("DATA URL NOT SET");
         document.getElementById('mhs-loader').innerHTML = "<h3 style='color:red'>Setup Error</h3><p>Data file URL is missing.</p>";
         return;
      }

      fetch(DATA_FILE_URL)
        .then(r => r.json())
        .then(data => {
          schoolData = data;
          schoolData.catalog.forEach((c, i) => {
             if(!c.id) c.id = "GEN_" + i;
             if(!Array.isArray(c.pathway_tags)) c.pathway_tags = [];
          });
          document.getElementById('mhs-loader').classList.add('hidden');
          showView('view-welcome');
          
          const sel = document.getElementById('pathwaySelect');
          sel.innerHTML = '<option value="">-- Select Pathway --</option>';
          const sortedPaths = schoolData.pathways.sort((a,b) => a.name.localeCompare(b.name));
          sortedPaths.forEach(p => {
             let opt = document.createElement('option'); opt.value = p.name; opt.text = p.name; sel.add(opt);
          });
          
          renderCards();
        })
        .catch(err => {
          console.error(err);
          const loader = document.getElementById('mhs-loader');
          if(loader) loader.innerHTML = "<h3 style='color:red'>Error Loading Data</h3><p>Could not connect to database file.</p>";
        });
  }

  // --- NAV ---
  function showView(id) {
    const root = document.getElementById('mhs-app-root');
    root.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }

  // --- SETUP ---
  function populateCategories() {
    const sel = document.getElementById('categorySelect');
    [...new Set(schoolData.pathways.map(p => p.category))].forEach(c => {
      let opt = document.createElement('option'); opt.value = c; opt.text = c; sel.add(opt);
    });
  }

  // --- HELPER: Auto-Bold Labels, Links, and Line Breaks ---
  function formatDescription(text) {
      if (!text) return '';
      
      // 1. Auto-Bold logic:
      // Look for lines starting with "Some Text:" and bold the "Some Text" part.
      // (?!http) prevents it from bolding "https:" in URLs
      let formatted = text.replace(/^((?!http)[^:\n]+):/gm, '<strong>$1</strong>:');

      // 2. Replace newlines with <br>
      formatted = formatted.replace(/\n/g, '<br>');

      // 3. Auto-link URLs -> Display "More Info"
      formatted = formatted.replace(
          /(https?:\/\/[^\s]+)/g, 
          '<a href="$1" target="_blank" style="color:#D21F28; text-decoration:underline; font-weight:bold;">More Info</a>'
      );
      
      return formatted;
  }

  function renderCards() {
    const grid = document.getElementById('cardGrid'); 
    grid.innerHTML = '';
    
    schoolData.pathways.forEach(p => {
      const card = document.createElement('div'); 
      card.className = 'card';
      
      // Use the helper we wrote earlier to format links/newlines
      const descHtml = formatDescription(p.description);

      card.innerHTML = `
        <div style="font-size:10px; color:#888; text-transform:uppercase; font-weight:bold;">${p.category}</div>
        <h4 style="margin:10px 0; color:#333;">${p.name}</h4>
        
        <div class="desc-box" id="desc-${p.name.replace(/\s/g,'')}">
            <div style="font-size:12px; color:#666; line-height:1.5;">
                ${descHtml}
            </div>
        </div>
        
        <button class="toggle-link">Read More +</button>
        <br>
        
        <button class="btn-sm" style="color:#D21F28; border-color:#D21F28">Select Pathway</button>
      `;
      
      // Logic for "Select" button
      card.querySelector('.btn-sm').onclick = function() { selectPath(p.category, p.name); };

      // Logic for "Read More" toggle
      const toggleBtn = card.querySelector('.toggle-link');
      const descBox = card.querySelector('.desc-box');

      toggleBtn.onclick = function() {
          const isExpanded = descBox.classList.contains('expanded');
          
          if (isExpanded) {
              // Collapse it
              descBox.classList.remove('expanded');
              toggleBtn.innerText = "Read More +";
          } else {
              // Expand it
              descBox.classList.add('expanded');
              toggleBtn.innerText = "Show Less -";
          }
      };

      grid.appendChild(card);
    });
  }

  function selectPath(cat, name) {
    // We removed categorySelect, so just set the pathway directly
    document.getElementById('pathwaySelect').value = name;
    checkReady();
    showView('view-form');
  }
  
  function filterPathways() {
    const cat = document.getElementById('categorySelect').value;
    const sel = document.getElementById('pathwaySelect');
    sel.innerHTML = '<option value="">-- Select Path --</option>';
    if(cat) schoolData.pathways.filter(p=>p.category===cat).forEach(p=>{
       let opt=document.createElement('option'); opt.value=p.name; opt.text=p.name; sel.add(opt);
    });
  }
  
  function checkReady() {
    const g = document.getElementById('gradeSelect').value;
    const p = document.getElementById('pathwaySelect').value;
    const fn = document.getElementById('inputFName').value;
    const ln = document.getElementById('inputLName').value;
    const id = document.getElementById('inputID').value;
    
    // Button is enabled only if ALL fields have values
    document.getElementById('startBtn').disabled = !(g && p && fn && ln && id);
  }
  
  // Add Event Listeners for the new inputs in initApp():
  // document.getElementById('inputFName').addEventListener('input', checkReady);
  // document.getElementById('inputLName').addEventListener('input', checkReady);
  // document.getElementById('inputID').addEventListener('input', checkReady);
  
  async function sendToGoogleForm() {
  const simplify = (c) => ({
      id: c.id,
      title: c.title,
      credits: c.credits
  });

  const studentData = {
      firstName: document.getElementById('inputFName').value,
      lastName:  document.getElementById('inputLName').value,
      studentId: document.getElementById('inputID').value,
      grade:     userState.grade,
      pathway:   userState.pathway,
      courses:   {
          core: userState.cart.core.map(item => Array.isArray(item) ? [simplify(item[0]), simplify(item[1])] : simplify(item)),
          electives: userState.cart.electives.map(simplify),
          alternates: userState.cart.alternates.map(simplify)
      }
  };

  const formData = new FormData();
  formData.append(FORM_FIELDS.firstName, studentData.firstName);
  formData.append(FORM_FIELDS.lastName, studentData.lastName);
  formData.append(FORM_FIELDS.studentId, studentData.studentId);
  formData.append(FORM_FIELDS.jsonData, JSON.stringify(studentData));

  const finishBtn = document.getElementById('btn-finish');
  finishBtn.innerText = "Submitting...";
  finishBtn.disabled = true;

  // --- RETRY LOGIC ENGINE ---
  const MAX_RETRIES = 3;
  let attempt = 0;
  let success = false;

  while (attempt < MAX_RETRIES && !success) {
      try {
          // We use 'no-cors' because Google Forms doesn't return a CORS header, 
          // but the data still reaches the sheet.
          await fetch(GOOGLE_FORM_URL, {
              method: "POST",
              mode: "no-cors",
              body: formData
          });
          
          success = true; // In 'no-cors' mode, if fetch doesn't throw, we assume success
      } catch (err) {
          attempt++;
          if (attempt < MAX_RETRIES) {
              console.warn(`Submission failed. Retry attempt ${attempt}...`);
              // Wait before retrying: 1sec, then 2sec, then 4sec
              await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 500));
          } else {
              console.error("Final submission attempt failed.", err);
              showModal("Connection Error", "We're having trouble reaching the server due to high traffic. Please try clicking Submit again in a few seconds.", false);
          }
      }
  }

  if (success) {
      populateReceipt();
      document.getElementById('finishModal').style.display = 'flex';
  }

  finishBtn.innerText = "Review & Submit";
  finishBtn.disabled = false;
}

  // --- SHOPPING ---
  function initShopping() {
    // 1. Capture Values
    const grade = document.getElementById('gradeSelect').value;
    const pathway = document.getElementById('pathwaySelect').value;
    const fname = document.getElementById('inputFName').value.trim();
    const lname = document.getElementById('inputLName').value.trim();
    const sid = document.getElementById('inputID').value.trim();

    // 2. Validation Check
    let missing = [];
    if(!fname) missing.push("First Name");
    if(!lname) missing.push("Last Name");
    if(!sid) missing.push("Student ID");
    if(!grade) missing.push("Grade Level");
    if(!pathway) missing.push("Pathway");

    if(missing.length > 0) {
        let msg = "Please complete the following fields:<br><ul style='text-align:left; margin-top:10px;'>";
        missing.forEach(m => msg += `<li>${m}</li>`);
        msg += "</ul>";
        showModal("Missing Information", msg, false);
        return; 
    }

    // --- NEW: SENIOR CHECK LOGIC ---
    const seniorAlert = document.getElementById('senior-alert');
    // Ensure the element exists before trying to style it
    if (seniorAlert) {
        if (grade === '12') {
            seniorAlert.style.display = 'block'; // Show it
        } else {
            seniorAlert.style.display = 'none';  // Hide it
        }
    }
    // --------------------------------

    // 3. Success - Proceed to Shopping
    userState.grade = grade;
    userState.pathway = pathway;
    userState.cart.core = getDefaultCore(userState.grade);
    userState.cart.electives = [];
    userState.cart.alternates = [];

    document.getElementById('studentHeader').innerText = `Grade ${userState.grade} | ${userState.pathway}`;
    renderCart();
    
    // Auto-select the "My Pathway" tab
    const pathBtn = document.querySelector('.tab-cat[data-type="pathway"]');
    if(pathBtn) pathBtn.click();

    showView('view-shopping');

    // --- NEW: TRIGGER TOUR ---
    // Optional: check localStorage if you only want it to run once per user
    if(!localStorage.getItem('mhs_tour_seen')) { 
      
      // Define tour steps
      const tour = new TourGuide([
        {
          target: '#coreSlots',
          title: 'Review Core Classes',
          text: 'These are your pre-assigned core courses.\n\nNeed Honors or AP? Click the "Swap" button on any core class to change the level.'
        },
        {
          target: '.tab-group',
          title: 'Choose Electives',
          text: 'Use these tabs to browse courses.\n\nREQUIREMENTS (Over 4 Years):\n‚Ä¢ 6 Pathway Courses\n‚Ä¢ 2 Required Electives (Language, Fine Arts, Tech)\n‚Ä¢ 3 General Electives'
        },
        {
          // FIX: Target only the FIRST slot, or fallback to the list if empty
          target: document.querySelector('#catalogList .slot') ? '#catalogList .slot:first-child' : '#catalogList', 
          title: 'Add Your Courses',
          text: 'Browse the list below and click "+ ADD".\n\nYou must select enough electives to reach 7 Credits total, plus 2 Alternates.'
        },
        {
          target: '#btn-finish',
          title: 'Review & Submit',
          text: 'Once your "Credits" counter at the top left says 7/7, click here to finalize your schedule.'
        }
      ]);

      // Small delay to ensure view is rendered
      setTimeout(() => tour.start(), 500);      
    } // end localStorage check
  }

  // Helper to find exact course or fallback
  function findC(name) {
      let match = schoolData.catalog.find(c => c.title.toLowerCase() === name.toLowerCase());
      if(!match) match = schoolData.catalog.find(c => c.title.toLowerCase().startsWith(name.toLowerCase()));
      
      // Fallback dummy if JSON is out of date
      if(!match) {
          console.warn("Missing data for:", name);
          return { id: "MISS_"+name.replace(/\s/g,''), title: name, credits: (name.includes("Essentials")||name.includes("Government")||name.includes("History")) ? 0.5 : 1.0, type: "Core" };
      }
      return match;
  }

  function getDefaultCore(grade) {
    let cores = [];
    if(grade === "9") {
        cores.push(findC("English I"));
        cores.push([ findC("Oklahoma History"), findC("High School Essentials I") ]); 
        cores.push(findC("Physical Science"));
        cores.push(findC("Algebra I"));
    } else if(grade === "10") {
        cores.push(findC("English II"));
        cores.push([ findC("World History"), findC("High School Essentials II") ]);
        cores.push(findC("Geometry"));
        cores.push(findC("Biology"));
    } else if(grade === "11") {
        cores.push(findC("English III"));
        cores.push(findC("US History")); 
        cores.push(findC("Algebra II"));
        cores.push(findC("Chemistry"));
    } else {
        // Senior Logic
        cores.push(findC("English IV"));
        // Create the dummy "Open" slot for 2nd semester gov
        let openSlot = { id: "OPEN_ELEC_SR", title: "Open Elective", credits: 0.5, type: "Placeholder" };
        cores.push([ findC("American Government"), openSlot ]);
        cores.push(findC("Algebra II")); 
    }
    return cores;
  }

  // --- UPDATED REMOVE FUNCTIONS (With Debugging) ---
  function remElec(i) { 
      console.log(`[remElec] Request to remove Index ${i}`);
      console.log(`[remElec] Array before:`, JSON.parse(JSON.stringify(userState.cart.electives)));
      
      userState.cart.electives.splice(i,1); 
      
      console.log(`[remElec] Array after:`, JSON.parse(JSON.stringify(userState.cart.electives)));
      
      renderCart(); 
      refreshCatalog(); 
  }
   
  function remAlt(i) { 
      console.log(`[remAlt] Request to remove Alternate Index ${i}`);
      userState.cart.alternates.splice(i,1); 
      renderCart(); 
      refreshCatalog(); 
  }

  function refreshCatalog() {
      const activeBtn = document.querySelector('.tab-cat.active');
      if(activeBtn && activeBtn.dataset.type) {
          renderCatalog(activeBtn.dataset.type, activeBtn);
      }
  }

  // --- HELPER: Create a "Nuclear" Delete Button ---
  // We use position:absolute to force it above any invisible overlapping containers
  function createSafeDeleteBtn(index, type) {
      const btn = document.createElement('span');
      btn.innerHTML = '&times;';
      btn.className = 'del-btn';
      btn.setAttribute('data-index', index);
      btn.setAttribute('data-type', type);
      btn.style.cssText = `
          color: #c00;
          font-weight: bold;
          font-size: 18px;
          cursor: pointer;
          padding: 5px 10px;
          margin-left: auto;
      `;
      return btn;
  }

  // --- RENDER CART (With Absolute Positioning) ---
  function renderCart() {
    console.log("--- RENDER CART START ---");
    
    // 1. Calculate Total Credits
    let tot = 0;
    userState.cart.core.forEach(i => Array.isArray(i) ? tot+=i[0].credits+i[1].credits : tot+=i.credits);
    userState.cart.electives.forEach(c => tot+=c.credits);
    document.getElementById('slotCount').innerText = tot;

    // 2. Render CORE (Standard)
    const cDiv = document.getElementById('coreSlots'); 
    cDiv.innerHTML='';
    // (Core rendering logic remains the same, assuming it works)
    userState.cart.core.forEach((item, i) => {
      const row = document.createElement('div');
      if(Array.isArray(item)) {
        row.innerHTML = `
            <div style="border-left: 4px solid #2196F3; background:white; border-bottom:1px solid #ddd;">
                <div class="split-header">Core ${i+1} (Semester Split)</div>
                <div class="cart-item">
                    <div><span class="cart-title">${item[0].title}</span></div>
                    <button class="btn-sm swap-btn-0">Swap</button>
                </div>
                <div class="cart-item" style="border-top:1px dashed #eee;">
                    <div>
                        <span class="cart-title">${item[1].title}</span>
                        <div style="font-size:10px; color:#888;">${item[1].credits} Credits</div>
                    </div>
                    ${item[1].type==='Placeholder' ? '' : '<button class="btn-sm swap-btn-1">Swap</button>'}
                </div>
            </div>`;
        row.querySelector('.swap-btn-0').onclick = function() { swapHonors(i, 0); };
        if(row.querySelector('.swap-btn-1')) row.querySelector('.swap-btn-1').onclick = function() { swapHonors(i, 1); };
      } else {
        row.innerHTML = `
            <div class="cart-item" style="border-left: 4px solid #4CAF50;">
                <div>
                    <span class="cart-label">Core ${i+1}</span>
                    <span class="cart-title">${item.title}</span>
                </div>
                <button class="btn-sm swap-btn">Swap</button>
            </div>`;
        row.querySelector('.swap-btn').onclick = function() { swapHonors(i, -1); };
      }
      cDiv.appendChild(row);
    });

    // 3. Render ELECTIVES (ABSOLUTE POSITION FIX)
    const eDiv = document.getElementById('flexSlots'); 
    eDiv.innerHTML='';
    const processed = new Set();
    let count=1;

    userState.cart.electives.forEach((c, idx) => {
      if(processed.has(idx)) return;
            
      const row = document.createElement('div');
      row.style.overflow = "visible"; 
      row.style.position = "relative";  // ‚Üê ADD THIS LINE
      
      if(c.credits >= 1) {
        // --- FULL YEAR ELECTIVE ---
        console.log(`Rendering Year Course: Index ${idx}, Title: ${c.title}`);
        
        // We add 'position: relative' to the cart-item so the absolute button sticks to IT
        row.innerHTML = `
            <div class="cart-item" style="border-left: 4px solid #FF9800; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <span class="cart-label">Elective ${count}</span>
                    <span class="cart-title">${c.title}</span>
                </div>
            </div>`;
        
        const btn = createSafeDeleteBtn(idx, 'elective');
        row.querySelector('.cart-item').appendChild(btn);
        
        processed.add(idx);

      } else {
        // --- SEMESTER PAIRS ---
        let partner = -1;
        for(let j=idx+1; j<userState.cart.electives.length; j++) {
            if(!processed.has(j) && userState.cart.electives[j].credits===0.5) { partner=j; break; }
        }

        const p1Title = c.title;
        const p2Title = partner!==-1 ? userState.cart.electives[partner].title : "<span style='color:#ccc; font-style:italic;'>-- Select Semester 2 --</span>";

        console.log(`Rendering Pair: TopIndex ${idx} & BotIndex ${partner}`);

        // We add 'position: relative' and 'padding-right' to BOTH containers
        row.innerHTML = `
            <div style="border-left: 4px solid #FF9800; background:white; border-bottom:1px solid #ddd;">
                <div class="split-header" style="background:#fff3e0; color:#e65100;">Elective ${count} (Semesters)</div>
                
                <div class="cart-item sem-top-container" style="display: flex; align-items: center; justify-content: space-between;">
                    <span class="cart-title">${p1Title}</span>
                </div>
                
                <div class="cart-item sem-bot-container" style="border-top:1px dashed #eee; display: flex; align-items: center; justify-content: space-between;">
                    <span class="cart-title">${p2Title}</span>
                </div>
            </div>`;

        // 1. Append Top Button
        const topContainer = row.querySelector('.sem-top-container');
        const btnTop = createSafeDeleteBtn(idx, 'elective');
        topContainer.appendChild(btnTop);

        // 2. Append Bottom Button (if partner exists)
        if(partner !== -1) {
            const botContainer = row.querySelector('.sem-bot-container');
            const btnBot = createSafeDeleteBtn(partner, 'elective');
            botContainer.appendChild(btnBot);
        }
        
        processed.add(idx); 
        if(partner!==-1) processed.add(partner);
      }
      eDiv.appendChild(row);
      count++;
    });
    
    // 4. Render EMPTY Slots
    for(let k=0; k<Math.floor(7-tot); k++) {
        eDiv.innerHTML += `<div class="slot-empty">-- Open Slot --</div>`;
    }
    
    // 5. Render ALTERNATES
    const aDiv = document.getElementById('altSlots'); 
    aDiv.innerHTML='';
    userState.cart.alternates.forEach((c,i) => {
        const d = document.createElement('div');
        d.innerHTML = `
            <div class="cart-item" style="background:#fff; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <span class="cart-label" style="color:#666;">Alternate ${i+1}</span>
                    <span class="cart-title" style="font-size:13px;">${c.title}</span>
                </div>
            </div>`;
        const btn = createSafeDeleteBtn(i, 'alternate');
        d.querySelector('.cart-item').appendChild(btn);
        aDiv.appendChild(d);
    });
    // --- EVENT DELEGATION (add this at the very end) ---
    const eDiv = document.getElementById('flexSlots');
    const aDiv = document.getElementById('altSlots');
    
    // Remove old listeners by cloning
    const newEDiv = eDiv.cloneNode(true);
    const newADiv = aDiv.cloneNode(true);
    eDiv.parentNode.replaceChild(newEDiv, eDiv);
    aDiv.parentNode.replaceChild(newADiv, aDiv);
    
    // Single listener for electives
    newEDiv.addEventListener('click', function(e) {
        const btn = e.target.closest('.del-btn');
        if (btn) {
            const idx = parseInt(btn.getAttribute('data-index'), 10);
            console.log('[Delegation] Removing elective at index:', idx);
            userState.cart.electives.splice(idx, 1);
            renderCart();
            refreshCatalog();
        }
    });
    
    // Single listener for alternates
    newADiv.addEventListener('click', function(e) {
        const btn = e.target.closest('.del-btn');
        if (btn) {
            const idx = parseInt(btn.getAttribute('data-index'), 10);
            console.log('[Delegation] Removing alternate at index:', idx);
            userState.cart.alternates.splice(idx, 1);
            renderCart();
            refreshCatalog();
        }
    });

    console.log("--- RENDER CART END ---");
  }
  
  function renderCatalog(type, btnEl) {
    if(btnEl) {
        document.querySelectorAll('.tab-cat').forEach(b => b.classList.remove('active'));
        btnEl.classList.add('active');
    }
    const box = document.getElementById('guidanceBox');
    const list = document.getElementById('catalogList'); 
    list.innerHTML='';
    
    // 1. Get current student grade (as string)
    const myGrade = String(userState.grade);
    let courses = [];
    
    // 2. Filter Logic (Includes Grade Check)
    if(type==='pathway') {
       courses = schoolData.catalog.filter(c => 
           c.pathway_tags.includes(userState.pathway) && 
           c.grades.map(g => String(g).trim()).includes(myGrade)
       );
       const count = userState.cart.electives.filter(c=>c.pathway_tags.includes(userState.pathway)).length;
       box.innerHTML = count===0 ? "<strong>Guidance:</strong> Please select 1-2 classes from your pathway." : "<strong>Good job!</strong> You have pathway classes selected.";
       box.className = count===0 ? "guide warn" : "guide";
    } else {
       box.innerHTML = type==='required' ? "Required Electives (Arts, PE, Language)" : "General Electives";
       box.className = "guide";
       courses = schoolData.catalog.filter(c => 
           c.type.includes(type==='required'?"Required":"General") &&
           c.grades.map(g => String(g).trim()).includes(myGrade)
       );
    }

    if(courses.length === 0) {
        list.innerHTML = `<div style="padding:15px; color:#666; font-style:italic;">No courses available for Grade ${myGrade} in this category.</div>`;
        return;
    }

    courses.forEach(c => {
      const isAdd = userState.cart.electives.concat(userState.cart.alternates).find(x=>x.id==c.id);
      
      // Credit Label
      let creditLabel = "Year"; 
      let labelColor = "#eee";
      if (c.credits === 0.5) creditLabel = "Semester";
      else if (c.credits === 0) { creditLabel = "Non-Credit"; labelColor = "#fff3cd"; }

      // Fee Logic
      let feeBadge = '';
      if (c.description && (c.description.includes("$") || /\bfee\b/i.test(c.description))) {
          feeBadge = `<span style="background:#d4edda; color:#155724; border:1px solid #c3e6cb; padding:2px 6px; border-radius:4px; font-weight:bold; margin-right:5px;">$ Fee</span>`;
      }

      // Grade Display
      let gradeDisplay = c.grades.join(', ');

      const div = document.createElement('div');
      div.className = 'slot';
      div.style.display = 'block';
      div.style.padding = '15px'; // Increased padding slightly for better readability
      
      div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
                <strong style="color:#D21F28; font-size:15px;">${c.title}</strong>
                <div style="font-size:11px; color:#666; margin-top:4px; display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                    <span style="background:${labelColor}; padding:2px 6px; border-radius:4px; font-weight:bold;">${creditLabel} (${c.credits})</span>
                    ${feeBadge}
                    <span>‚Ä¢ Grades: ${gradeDisplay}</span>
                </div>
            </div>
            ${isAdd ? '<span style="color:green; font-weight:bold; font-size:12px; white-space:nowrap; margin-left:10px;">ADDED</span>' : 
              `<button class="btn-sm add-btn" style="background:#28a745; color:white; border:none; padding:6px 12px; white-space:nowrap; margin-left:10px;">+ ADD</button>`}
          </div>
          
          <div style="font-size:13px; color:#444; margin-top:8px; line-height:1.4;">
             ${c.description || ''}
          </div>
          
          <div style="font-size:11px; color:#856404; margin-top:6px; font-style:italic;">
             ${c.prerequisite ? '<strong>Prereq:</strong> '+c.prerequisite : ''}
          </div>
      `;

      if(!isAdd) {
          div.querySelector('.add-btn').onclick = function() { add(c.id); };
      }
      list.appendChild(div);
    });
  }
  
  function swapHonors(coreIndex, subIndex) {
    pendingCourseSwap = { coreIndex: coreIndex, subIndex: subIndex };

    // 1. Identify Subject based on current title
    let currentTitle = "";
    if(subIndex === -1) currentTitle = userState.cart.core[coreIndex].title;
    else currentTitle = userState.cart.core[coreIndex][subIndex].title;
    
    let subject = "";
    if (currentTitle.includes("English")) subject = "English";
    else if (currentTitle.match(/(Math|Algebra|Geometry|Calculus|Statistics)/)) subject = "Math";
    else if (currentTitle.match(/(Science|Biology|Chemistry|Physics|Zoology|Anatomy)/)) subject = "Science";
    else if (currentTitle.match(/(History|Government)/)) subject = "History";

    document.getElementById('swapSourceLabel').innerText = currentTitle;

    // 2. Get Allowed List from Constant
    const allowedNames = ALLOWED_SWAPS[userState.grade][subject];
    const select = document.getElementById('swapTargetSelect');
    select.innerHTML = '<option value="">-- Select New Course --</option>';

    if (allowedNames) {
        allowedNames.forEach(name => {
            const realC = findC(name); // Use the helper from Update #2
            if(realC) {
                const opt = document.createElement('option');
                opt.value = realC.id;
                opt.text = `${realC.title} (${realC.credits})`;
                select.appendChild(opt);
            }
        });
    }
    document.getElementById('swapModal').style.display = 'flex';
  }

  function confirmCourseSwap() {
    const newId = document.getElementById('swapTargetSelect').value;
    if(!newId) { closeModal('swapModal'); return; }

    const newCourse = schoolData.catalog.find(c => String(c.id) === String(newId));
    if(!newCourse) return;

    const p = pendingCourseSwap; // Short alias

    // LOGIC: AP World (Year) eats the whole slot (replaces array with object)
    if(newCourse.title.includes("AP World History")) {
        userState.cart.core[p.coreIndex] = newCourse;
    }
    // LOGIC: Swapping FROM AP World back to Standard (restores array)
    else if(p.subIndex === -1 && userState.cart.core[p.coreIndex].title.includes("AP World History")) {
         userState.cart.core[p.coreIndex] = [ newCourse, findC("High School Essentials II") ];
    }
    // LOGIC: Senior Gov
    else if(newCourse.title.includes("AP US Government")) {
        userState.cart.core[p.coreIndex] = newCourse;
    }
    else if(p.subIndex === -1 && userState.cart.core[p.coreIndex].title.includes("AP US Government")) {
        userState.cart.core[p.coreIndex] = [ newCourse, { id: "OPEN_ELEC_SR", title: "Open Elective", credits: 0.5, type: "Placeholder" } ];
    }
    // STANDARD SWAP
    else {
        if(p.subIndex === -1) userState.cart.core[p.coreIndex] = newCourse;
        else userState.cart.core[p.coreIndex][p.subIndex] = newCourse;
    }

    renderCart();
    closeModal('swapModal');
  }
  
  function populateReceipt() {
    // 1. Fill Student Info
    document.getElementById('receipt-name').innerText = 
        document.getElementById('inputFName').value + " " + document.getElementById('inputLName').value;
    document.getElementById('receipt-id').innerText = document.getElementById('inputID').value;
    document.getElementById('receipt-grade').innerText = userState.grade;
    document.getElementById('receipt-path').innerText = userState.pathway;

    // 2. Build Course List HTML
    let listHTML = '<ul style="margin:0; padding-left:20px;">';
    
    // Core
    userState.cart.core.forEach((item, i) => {
        if(Array.isArray(item)) {
             listHTML += `<li><strong>Core:</strong> ${item[0].title} / ${item[1].title}</li>`;
        } else {
             listHTML += `<li><strong>Core:</strong> ${item.title}</li>`;
        }
    });

    // Electives
    userState.cart.electives.forEach(c => {
        listHTML += `<li><strong>Elective:</strong> ${c.title}</li>`;
    });

    // Alternates
    listHTML += '</ul><div style="margin-top:10px; font-style:italic; border-top:1px dashed #ccc; padding-top:5px;"><strong>Alternates:</strong></div><ul style="margin:0; padding-left:20px; color:#666;">';
    userState.cart.alternates.forEach(c => {
        listHTML += `<li>${c.title}</li>`;
    });
    listHTML += '</ul>';

    document.getElementById('receipt-list').innerHTML = listHTML;
  }
  
  // Print Helper
  window.printReceipt = function() {
      // Simple print triggers the browser print dialog
      // Users can choose "Save as PDF" from there
      window.print();
  }


// --- NEW: Custom Modal Helper ---
  function showModal(title, text, isConfirm, yesCallback) {
      document.getElementById('msgTitle').innerText = title;
      document.getElementById('msgBody').innerHTML = text.replace(/\n/g, '<br>');
      
      const okBtn = document.getElementById('msgOkBtn');
      const cancelBtn = document.getElementById('msgCancelBtn');

      // Reset Clones to remove old listeners
      const newOk = okBtn.cloneNode(true);
      const newCancel = cancelBtn.cloneNode(true);
      okBtn.parentNode.replaceChild(newOk, okBtn);
      cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

      document.getElementById('msgModal').style.display = 'flex';

      if (isConfirm) {
          newCancel.style.display = 'inline-block';
          newOk.innerText = "Yes, Proceed";
          newCancel.onclick = function() { document.getElementById('msgModal').style.display = 'none'; };
          newOk.onclick = function() { 
              document.getElementById('msgModal').style.display = 'none'; 
              if(yesCallback) yesCallback(); 
          };
      } else {
          newCancel.style.display = 'none';
          newOk.innerText = "OK";
          newOk.onclick = function() { document.getElementById('msgModal').style.display = 'none'; };
      }
  }

  // --- UPDATED: Add to Cart Logic (Async Chain) ---
  function add(id) {
    const c = schoolData.catalog.find(x => x.id == id);
    if (!c) return;

    // Helper: Check description for "$" or "fee"
    const hasFee = (desc) => desc && (desc.includes("$") || /\bfee\b/i.test(desc));

    // Step 3: actually add it
    const performAdd = () => {
        let total = 0;
        userState.cart.core.forEach(item => {
            if (Array.isArray(item)) total += item[0].credits + item[1].credits;
            else total += item.credits;
        });
        userState.cart.electives.forEach(c => total += c.credits);

        if (total + c.credits <= 7) {
            userState.cart.electives.push(c);
        } else if (userState.cart.alternates.length < 2) {
            showModal("Schedule Full", "Your 7 credits are full.<br>Adding this as an <strong>Alternate</strong>.", false);
            userState.cart.alternates.push(c);
        } else {
            showModal("Cart Full", "You have 7 Credits and 2 Alternates.<br>Please remove something first.", false);
            return;
        }
        
        renderCart(); 
        const activeBtn = document.querySelector('.tab-cat.active');
        if(activeBtn) renderCatalog(activeBtn.dataset.type, activeBtn);
    };

    // Step 2: Check Prereq
    const checkPrereq = () => {
        if (c.prerequisite && c.prerequisite.length > 2) {
            showModal("Prerequisite Check", `<strong>Course:</strong> ${c.title}<br><strong>Requires:</strong> ${c.prerequisite}<br><br>Have you met this requirement?`, true, performAdd);
        } else {
            performAdd();
        }
    };

    // Step 1: Check Fee
    if (hasFee(c.description)) {
        showModal("Course Fee Alert", `<strong>${c.title}</strong> requires an additional fee.<br>See description for details.<br><br>Do you accept this cost?`, true, checkPrereq);
    } else {
        checkPrereq();
    }
  }

  // --- UPDATED: Finish Schedule (No more Alert) ---
  function finishSchedule() {
    let tot=0; 
    userState.cart.core.forEach(i=>tot+=Array.isArray(i)?2:1); 
    userState.cart.electives.forEach(i=>tot+=i.credits);
    
    if(tot < 7) {
        showModal("Incomplete Schedule", `You have selected <strong>${tot}/7</strong> credits.<br>You must fill your schedule.`, false);
        return;
    }
    if(userState.cart.alternates.length < 2) {
        showModal("Incomplete Alternates", "Please select at least 2 alternates.", false);
        return;
    }
    
    sendToGoogleForm();
  }


  
})();
</script>
