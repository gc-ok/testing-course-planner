<style>
  /* --- SCOPED CSS (Safe for Finalsite) --- */
  #mhs-app-root { 
    font-family: 'Roboto', sans-serif; 
    background: #fff; 
    color: #333; 
    min-height: 800px; 
    display: flex; 
    flex-direction: column; 
    position: relative; 
    max-width: 1200px; 
    margin: 0 auto; 
    border: 1px solid #eaeaea;
  }
  
  /* Utils */
  #mhs-app-root .hidden { display: none !important; }
  #mhs-app-root .view-section { display: none; animation: mhsFadeIn 0.4s; padding: 10px; }
  #mhs-app-root .view-section.active { display: block; }
  @keyframes mhsFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Layout */
  #mhs-app-root .header { padding: 20px 15px; border-bottom: 4px solid #D21F28; margin-bottom: 20px; background: #fafafa; }
  #mhs-app-root .title { color: #D21F28; font-size: 28px; font-weight: 700; line-height: 1.2; }
  
  /* Components */
  #mhs-app-root .btn { padding: 12px 24px; font-weight: 700; border: none; border-radius: 4px; cursor: pointer; display:inline-block; margin:5px; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
  #mhs-app-root .btn-red { background: #D21F28; color: white; }
  #mhs-app-root .btn-red:hover { background: #a0181f; }
  #mhs-app-root .btn-outline { background: white; color: #D21F28; border: 2px solid #D21F28; }
  #mhs-app-root .btn-sm { padding: 6px 12px; font-size: 11px; border: 1px solid #ddd; background: white; border-radius: 3px; cursor: pointer; font-weight: bold; }
  #mhs-app-root .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white; transition: 0.2s; margin-bottom:15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  
  /* Grid & Columns */
  #mhs-app-root .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
  #mhs-app-root .shop-cols { display: flex; gap: 20px; align-items: flex-start; }
  #mhs-app-root .col-left { flex: 0 0 340px; width: 100%; border: 1px solid #ddd; border-radius: 8px; background: #fff; position: sticky; top: 10px; z-index: 100; max-height: 85vh; overflow-y: auto; }
  #mhs-app-root .col-right { flex: 1; min-width: 0; }
  
  /* Forms */
  #mhs-app-root select, #mhs-app-root input[type=text] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
  #mhs-app-root label { font-weight: bold; font-size: 13px; display: block; margin-bottom: 5px; color: #444; }
  
  /* Tabs */
  #mhs-app-root .tab-group { display: flex; background: #f1f3f5; padding: 5px; border-radius: 8px; margin-bottom: 20px; gap: 5px; }
  #mhs-app-root .tab-cat { flex: 1; text-align: center; padding: 12px 5px; font-size: 13px; font-weight: 700; color: #666; background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; }
  #mhs-app-root .tab-cat.active { background: white !important; color: #D21F28 !important; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  /* Mobile */
  @media (max-width: 900px) {
    #mhs-app-root .shop-cols { flex-direction: column; }
    #mhs-app-root .col-left { position: static; flex: 1 1 auto; width: 100%; box-sizing: border-box; max-height: none; }
    #mhs-app-root .grid { grid-template-columns: 1fr; }
  }

  /* Descriptions & Cart */
  .desc-box { max-height: 90px; overflow: hidden; position: relative; transition: max-height 0.5s ease; font-size: 13px; color: #666; }
  .desc-box.expanded { max-height: 1500px; }
  .desc-box::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1)); pointer-events: none; }
  .desc-box.expanded::after { display: none; }
  
  /* UPDATED CART STYLES */
  .cart-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: relative; background: white; }
  .cart-item:hover { background: #fafafa; }
  .cart-label { display: block; font-size: 10px; color: #999; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
  .cart-title { font-size: 14px; font-weight: 600; color: #333; line-height: 1.2; }
  
  .split-header { background: #e3f2fd; color: #1565c0; font-size: 10px; font-weight: bold; padding: 6px 15px; text-transform: uppercase; letter-spacing: 0.5px; border-top: 1px solid #eee; }
  .slot-empty { padding: 15px; color: #aaa; font-size: 13px; font-style: italic; background: #fafafa; border-bottom: 1px solid #eee; text-align: center; }

  /* UPDATED DELETE BUTTON */
  .del-btn { color: #c00; font-weight: bold; font-size: 18px; cursor: pointer; padding: 5px 10px; margin-left: auto; z-index: 5; }
  .del-btn:hover { color: red; transform: scale(1.1); }

  /* TOUR STYLES */
  #mhs-app-root .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9998; display: none; opacity: 0; transition: opacity 0.3s; }
  #mhs-app-root .tour-active-element { position: relative; z-index: 9999 !important; box-shadow: 0 0 0 4px #D21F28, 0 0 20px rgba(0,0,0,0.5); border-radius: 8px; pointer-events: none; background: white; }
  #mhs-app-root .tour-tooltip { position: absolute; width: 300px; background: white; z-index: 10000; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: none; }
  #mhs-app-root .tour-tooltip::after { content: ''; position: absolute; top: -8px; left: 20px; border-width: 0 8px 8px; border-style: solid; border-color: transparent transparent #fff transparent; }
  #mhs-app-root .tour-header { font-weight: 900; color: #D21F28; font-size: 16px; margin-bottom: 8px; text-transform: uppercase; }
  #mhs-app-root .tour-body { font-size: 13px; line-height: 1.5; color: #444; margin-bottom: 15px; white-space: pre-wrap; }
  #mhs-app-root .tour-footer { display: flex; justify-content: flex-end; gap: 8px; }
  #mhs-app-root .tour-footer .btn-red { 
      background-color: #D21F28 !important; 
      color: white !important;
      border: 1px solid #D21F28 !important;
  }

  /* --- PRINT CONTROL (NUCLEAR OPTION) --- */
  @media print {
    /* 1. Hide everything in the browser body (Header, Footer, Nav, etc.) */
    body * {
      visibility: hidden;
    }

    /* 2. Reset the Modal Container to be visible */
    #finishModal, #finishModal * {
      visibility: visible !important;
    }

    /* 3. Force the Modal to float over everything else at the very top */
    #finishModal {
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      background: white !important; /* Ensure transparent backgrounds don't show website behind */
      z-index: 9999999 !important; /* Be on top of everything */
      display: block !important; /* Override flex to avoid print layout bugs */
    }

    /* 4. Hide the interactive buttons inside the modal (Close / Print) */
    #finishModal button {
      display: none !important;
    }

    /* 5. Improve Receipt Styling for Paper */
    .modal {
        box-shadow: none !important;
        border: none !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* 6. Ensure Background Graphics (colors/borders) print */
    * {
        -webkit-print-color-adjust: exact !important;   /* Chrome/Safari */
        print-color-adjust: exact !important;           /* Firefox */
    }
  }

  /* MODALS */
  .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; justify-content: center; align-items: center; }
  .modal-bg[style*="display: block"], .modal-bg[style*="display: flex"] { display: flex !important; }
  .modal { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 90%; }

  /* --- VALIDATION ANIMATIONS --- */
  @keyframes mhsShake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }

  .error-shake {
    animation: mhsShake 0.4s ease-in-out;
    border: 1px solid #dc3545 !important; /* Red Border */
    background-color: #fff8f8 !important; /* Light Red BG */
    color: #dc3545 !important;
  }
  
  /* For the "Select Semester 2" text */
  .error-text {
    color: #dc3545 !important;
    font-weight: bold !important;
    animation: mhsShake 0.4s ease-in-out;
  }

  /* Sticky Submit Footer */
  .sticky-footer {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 15px;
      border-top: 1px solid #ddd;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.1); /* Shadow pointing up */
      z-index: 20; /* Ensure it sits on top of the list */
  }

  /* Optional: Add extra padding to the bottom of the list so the last item 
    doesn't get hidden behind the sticky button when scrolled all the way down */
  #mhs-app-root .col-left {
      padding-bottom: 0 !important; /* Reset the container padding */
  }
  /* We add a spacer at the bottom of the content flow instead */
  .spacer-bottom {
      height: 80px; 
  }

  @keyframes btnPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(210, 31, 40, 0.7); }
      70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(210, 31, 40, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(210, 31, 40, 0); }
  }
  .btn-ready {
      animation: btnPulse 2s infinite;
  }

</style>

<div id="mhs-app-root">
  <div id="mhs-loader" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:50; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <h3 style="color:#D21F28">Loading Course Catalog...</h3>
    <p style="color:#666; font-size:12px;">Connecting to database file...</p>
  </div>

  <div class="header">
    <div class="title">Mustang High School</div>
    <div style="font-size:14px; color:#666; font-weight: 500;">2026-2027 Course Pathway Planner</div>
  </div>

  <div class="main">
    <div id="view-welcome" class="view-section">
      <div class="card" style="text-align:center; padding:60px 20px; border-top: 6px solid #D21F28;">
        <h2 style="color:#D21F28; margin-bottom:15px; font-size: 32px;">Welcome, Bronco!</h2>
        <p style="max-width:600px; margin:0 auto 30px auto; color:#555; font-size: 16px; line-height: 1.6;">
          Plan your 2026-2027 schedule here. Use this webpage as a guide to fill out the paper copy of your Schedule Planner/Course requests that you are turning into the counselor. 
          <br><br><strong>Goal:</strong> 7 Credits + 2 Alternates.
          <br><br>Be sure to complete this webpage AND turn in your physical paper to the counselor by the deadline.
        </p>
        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
          <button class="btn btn-red" id="btn-know-path">I Know My Pathway</button>
          <button class="btn btn-outline" id="btn-explore-path">Explore Pathways</button>
        </div>
      </div>
    </div>

    <div id="view-explore" class="view-section">
      <button class="btn-sm" id="btn-back-explore">← Back</button>
      <h2 style="color:#D21F28; text-align:center; margin:20px 0;">Career Pathways</h2>
      <div id="cardGrid" class="grid"></div>
    </div>

    <div id="view-form" class="view-section">
      <button class="btn-sm" id="btn-back-home" style="margin-bottom:15px;">← Back to Home</button>
      <div style="max-width:550px; margin:0 auto;" class="card">
        <h3 style="color:#D21F28; margin-bottom:20px; margin-top:0;">Student Profile</h3>
        <div style="display:flex; gap:15px; margin-bottom: 5px;">
          <div style="flex:1;">
            <label>First Name <span style="color:red">*</span></label>
            <input type="text" id="inputFName" placeholder="Ex: Jane">
          </div>
          <div style="flex:1;">
            <label>Last Name <span style="color:red">*</span></label>
            <input type="text" id="inputLName" placeholder="Ex: Doe">
          </div>
        </div>
        <label>Student ID # <span style="color:red">*</span></label>
        <input type="text" id="inputID" placeholder="5-6 Digit ID" inputmode="numeric">
        <label>Grade Level Next Year <span style="color:red">*</span></label>
        <select id="gradeSelect">
          <option value="" disabled selected>Select Grade</option>
          <option value="9">Freshman (9th)</option>
          <option value="10">Sophomore (10th)</option>
          <option value="11">Junior (11th)</option>
          <option value="12">Senior (12th)</option>
        </select>
        <label>Selected Pathway <span style="color:red">*</span></label>
        <select id="pathwaySelect"></select>

        <div style="font-size:11px; color:#666; margin:15px 0; background:#f9f9f9; padding:10px; border-left:3px solid #ccc;">
          <strong>Privacy Notice:</strong> Your selections are recorded for schedule building.
        </div>

        <button id="startBtn" class="btn btn-red" style="width:100%; margin-top: 10px;">Start Building Schedule</button>
      </div>
    </div>

    <div id="view-shopping" class="view-section">
      <button class="btn-sm" id="btn-back-profile" style="margin-bottom:15px;">← Back to Profile</button>
      <div class="shop-cols">
        <div class="col-left">
            <div style="background:#333; color:white; padding:15px; border-radius:8px 8px 0 0;">
                <h4 id="studentHeader" style="margin:0;">My Schedule</h4>
                <div style="font-size:11px; opacity:0.8; margin-top:5px;">Credits: <span id="slotCount">0</span>/7</div>
            </div>
            
            <div id="coreSlots"></div>
            <div id="flexSlots"></div>
            
            <div style="background:#f4f4f4; padding:10px; border-top:2px solid #ddd;">
                <div style="font-size:10px; font-weight:bold; color:#666; margin-bottom:5px;">ALTERNATES (2 Required)</div>
                <div id="altSlots"></div>
            </div>

            <div style="padding:15px; background:#fff; border-top:1px solid #eee; font-size:11px; color:#555; line-height:1.4;">
                <p style="margin-top:0; margin-bottom:10px;">
                    <strong>Accelerated/AP Enrollment:</strong> Eligibility criteria apply; counselor verification is required prior to selection. These courses involve increased rigor and time commitments. Per district policy, no schedule changes or drops will be allowed after the first 8 days of the semester.
                </p>
                <p style="margin:0; padding-top:10px; border-top:1px dashed #ddd;">
                    <strong>Selection Notice & Privacy:</strong> This selection process is a request and does not guarantee enrollment into the course. All data submitted (Name, ID, Course Selections, etc.) is recorded and stored for the purpose of schedule building by the Counseling Department.
                </p>
            </div>

            <div class="spacer-bottom"></div>

            <div class="sticky-footer">
                <button class="btn btn-red" style="width:100%" id="btn-finish">Review & Submit</button>
            </div>
        </div>

        <div class="col-right">
          <div id="senior-alert" style="display:none; margin-bottom:15px; background:#ffebee; border:2px solid #D21F28; padding:15px; border-radius:6px; text-align:center;">
              <h4 style="color:#D21F28; margin:0 0 5px 0; font-size:16px; font-weight:900; text-transform:uppercase;">Attention Seniors</h4>
              <div style="font-weight:bold; color:#b71c1c; margin-bottom:5px;">
                  Your course requests must be done ON PAPER due to being on old graduation requirements.
              </div>
              <div style="font-size:12px; color:#333;">
                  You are welcome to browse electives here, but please use your official paper form for submission.
              </div>
          </div>

          <div style="margin-bottom:15px; background:#fff; border:1px solid #ddd; padding:12px; border-radius:6px; font-size:12px; color:#555; line-height:1.4;">
            <strong>How to choose electives:</strong>
            <ul style="margin:5px 0 0 0; padding-left:20px;">
              <li>Click the tabs below to switch between elective categories (Note that your REQUIRED core classes are already pre-populated and you can swap or change those out). </li>
            </ul>
          </div>

          <div class="tab-group">
            <button class="tab-cat active" data-type="pathway">My Pathway</button>
            <button class="tab-cat" data-type="required">Required</button>
            <button class="tab-cat" data-type="general">General</button>
          </div>
          <div id="guidanceBox" class="guide">Loading...</div>
          <div id="catalogList" class="grid" style="grid-template-columns:1fr;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="finishModal" class="modal-bg">
    <div class="modal" style="width:600px;">
      <div id="receipt-content">
        <h2 style="color:#D21F28; text-align:center; border-bottom: 2px solid #eee; padding-bottom: 10px;">Submission Complete</h2>
        <div id="receipt-data" style="margin: 20px 0; font-size: 14px;"></div>
        <div id="receipt-list" style="border: 1px solid #ddd; padding: 15px; background: #fafafa; border-radius: 4px;"></div>
      </div>
      <div style="text-align:right; margin-top:20px; display:flex; justify-content: flex-end; gap: 10px;">
        <button class="btn btn-outline" onclick="location.reload()">New Entry</button>
        <button class="btn btn-red" onclick="window.print()">Print PDF</button>
      </div>
    </div>
  </div>

  <div id="swapModal" class="modal-bg">
    <div class="modal" style="width: 380px;">
      <h3 style="margin-top:0;">Change Course Level</h3>
      <p style="font-size:13px; color:#666;">Select an alternative for: <br><strong id="swapSourceLabel" style="color:#D21F28;"></strong></p>
      <select id="swapTargetSelect"></select>
      <div style="text-align:right; margin-top:20px;">
        <button class="btn-sm" id="btn-cancel-swap">Cancel</button>
        <button class="btn-sm" id="btn-confirm-swap" style="background:#D21F28; color:white; border:none;">Confirm Change</button>
      </div>
    </div>
  </div>

  <div id="msgModal" class="modal-bg">
    <div class="modal" style="width: 400px;">
      <h3 id="msgTitle" style="color:#D21F28; margin-top:0;">Alert</h3>
      <p id="msgBody" style="font-size:14px; line-height:1.5;"></p>
      <div style="text-align:right; margin-top:20px;">
        <button id="msgCancelBtn" class="btn-sm" style="margin-right:8px;">Cancel</button>
        <button id="msgOkBtn" class="btn btn-red" style="padding:8px 20px;">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- TOUR GUIDE CLASS ---
class TourGuide {
  constructor(steps) {
    this.steps = steps;
    this.currentStep = 0;
    this.overlay = null;
    this.tooltip = null;
  }
  init() {
    if (!document.getElementById('tour-overlay')) {
      const root = document.getElementById('mhs-app-root');
      this.overlay = document.createElement('div');
      this.overlay.className = 'tour-overlay';
      this.overlay.id = 'tour-overlay';
      root.appendChild(this.overlay);

      this.tooltip = document.createElement('div');
      this.tooltip.className = 'tour-tooltip';
      this.tooltip.innerHTML = `<div class="tour-header" id="tour-title"></div><div class="tour-body" id="tour-text"></div><div class="tour-footer"><button class="btn-sm" id="tour-skip">Skip</button><button class="btn btn-red btn-sm" id="tour-next">Next</button></div>`;
      root.appendChild(this.tooltip);

      document.getElementById('tour-next').onclick = () => this.next();
      document.getElementById('tour-skip').onclick = () => this.end();
    } else {
      this.overlay = document.getElementById('tour-overlay');
      this.tooltip = document.querySelector('.tour-tooltip');
    }
  }
  start() {
    this.init();
    this.currentStep = 0;
    this.overlay.style.display = 'block';
    setTimeout(() => this.overlay.style.opacity = '1', 10);
    this.showStep();
  }
  showStep() {
    const step = this.steps[this.currentStep];
    const target = document.querySelector(step.target);
    document.querySelectorAll('.tour-active-element').forEach(el => el.classList.remove('tour-active-element'));
    this.tooltip.style.display = 'none';
    if (!target) { this.next(); return; }
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    target.classList.add('tour-active-element');
    document.getElementById('tour-title').innerText = step.title;
    document.getElementById('tour-text').innerText = step.text;
    document.getElementById('tour-next').innerText = (this.currentStep === this.steps.length - 1) ? 'Finish' : 'Next →';
    setTimeout(() => {
        const rect = target.getBoundingClientRect();
        const rootRect = document.getElementById('mhs-app-root').getBoundingClientRect();
        let top = (rect.bottom - rootRect.top) + 15;
        let left = (rect.left - rootRect.left);
        if (left + 300 > rootRect.width) left = rootRect.width - 320;
        if (left < 0) left = 10;
        this.tooltip.style.top = top + 'px';
        this.tooltip.style.left = left + 'px';
        this.tooltip.style.display = 'block';
    }, 400);
  }
  next() {
    this.currentStep++;
    if (this.currentStep >= this.steps.length) this.end();
    else this.showStep();
  }
  end() {
    this.overlay.style.opacity = '0';
    this.tooltip.style.display = 'none';
    document.querySelectorAll('.tour-active-element').forEach(el => el.classList.remove('tour-active-element'));
    setTimeout(() => { this.overlay.style.display = 'none'; }, 300);
  }
}

(function() {
  const DATA_FILE_URL = "./Finalsite_Course_Data.txt"; 
  const GOOGLE_FORM_URL = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSfLJcVHl8nMtnC9LUYlimfpjJ0T2UyV-me8Iv_y96tB2CTFog/formResponse";
  
  const FORM_FIELDS = {
      firstName: "entry.2022705835",
      lastName:  "entry.1204697517",
      studentId: "entry.823979582",
      jsonData:  "entry.1979462889"
  };

  let schoolData = {};
  let userState = { grade: null, pathway: null, cart: { core: [], electives: [], alternates: [] } };
  let pendingSwap = null;

  const ALLOWED_SWAPS = {
    "9": {
        "English": ["English I", "English I Accelerated"],
        "History": ["Oklahoma History", "Oklahoma History Accelerated"],
        "Science": ["Physical Science", "Biology Accelerated"],
        "Math": ["Algebra I", "Algebra I Accelerated", "Geometry", "Geometry Accelerated"]
    },
    "10": {
        "English": ["English II", "English II Accelerated"],
        "History": ["World History", "AP World History"], 
        "Science": ["Biology", "Biology Accelerated", "Chemistry", "PreAP Chemistry", "Physics"],
        "Math": ["Geometry", "Geometry Accelerated", "Algebra II", "Algebra II Accelerated", "STEM Algebra II Accelerated"]
    },
    "11": {
        "English": ["English III", "AP English Language & Composition"],
        "History": ["US History", "AP US History"],
        "Math": ["Algebra II", "Algebra II Accelerated", "STEM Algebra II Accelerated", "Intermediate Algebra", "PreCalculus Accelerated", "Algebra III", "Business Math", "AP PreCalculus", "AP Calculus AB", "AP Calculus BC", "Sports Statistics and Probability", "AP Statistics"],
        "Science": ["Physical Science", "Chemistry", "PreAP Chemistry", "Chemistry II", "AP Chemistry", "Physics", "AP Physics I", "AP Physics II", "STEM Physics Accelerated", "Zoology", "Zoology II", "Forensic Science", "Anatomy & Physiology", "AP Biology", "Environmental Science and Natural Resources", "AP Environmental Science", "Earth and Space Science"]
    },
    "12": {
        "English": ["English IV", "AP English Literature & Composition"],
        "History": ["American Government", "AP US Government and Politics"],
        "Math": ["Algebra II", "Algebra II Accelerated", "STEM Algebra II Accelerated", "Intermediate Algebra", "PreCalculus Accelerated", "Algebra III", "Business Math", "AP PreCalculus", "AP Calculus AB", "AP Calculus BC", "Sports Statistics and Probability", "AP Statistics"],
        "Science": ["Physical Science", "Chemistry", "PreAP Chemistry", "Chemistry II", "AP Chemistry", "Physics", "AP Physics I", "AP Physics II", "STEM Physics Accelerated", "Zoology", "Zoology II", "Forensic Science", "Anatomy & Physiology", "AP Biology", "Environmental Science and Natural Resources", "AP Environmental Science", "Earth and Space Science"]
    }
  };

  // Add this to your script to handle all course removals
  document.getElementById('mhs-app-root').addEventListener('click', function(e) {
      const btn = e.target.closest('.del-btn');
      if (!btn) return;

      const idx = parseInt(btn.getAttribute('data-index'), 10);
      const type = btn.getAttribute('data-type');

      if (type === 'elective') {
          userState.cart.electives.splice(idx, 1);
      } else if (type === 'alternate') {
          userState.cart.alternates.splice(idx, 1);
      }

      renderCart(); // Redraw the schedule
      
      // Update the catalog list so "+ ADD" buttons reappear for removed items
      const activeTab = document.querySelector('.tab-cat.active');
      if (activeTab) renderCatalog(activeTab.dataset.type);
  });

  function initApp() {
      fetch(DATA_FILE_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP Error! Status: ${response.status} (${response.statusText})`);
          }
          return response.json();
        })
        .then(data => {
          // 1. Set Data
          schoolData = data;
          
          // 2. Assign IDs if missing
          if (schoolData.catalog) {
              schoolData.catalog.forEach((c, i) => { 
                  if(!c.id) c.id = "gen_" + i; 
              });
          }

          // 3. Hide Loader
          const loader = document.getElementById('mhs-loader');
          if (loader) {
              loader.classList.add('hidden');
          }

          // 4. Render Initial Views
          showView('view-welcome');
          
          // Ensure these functions exist in your code, or this will error
          if (typeof populatePathways === "function") populatePathways();
          if (typeof renderExploreCards === "function") renderExploreCards();
        })
        .catch(e => {
          const loader = document.getElementById('mhs-loader');
          if (loader) {
              loader.innerHTML = `
                  <div style="text-align:center; padding:20px;">
                      <h3 style="color:red">Data Load Error</h3>
                      <p>Please check your internet connection or reload the page.</p>
                  </div>
              `;
          }
        });

      // --- Event Listeners ---
      const attach = (id, fn) => {
          const el = document.getElementById(id);
          if(el) el.onclick = fn;
      };

      const idInput = document.getElementById('inputID');
      if(idInput) idInput.oninput = function() { this.value = this.value.replace(/\D/g, ''); };

      attach('btn-know-path', () => showView('view-form'));
      attach('btn-explore-path', () => showView('view-explore'));
      attach('btn-back-explore', () => showView('view-welcome'));
      attach('btn-back-home', () => showView('view-welcome'));
      attach('btn-back-profile', () => showView('view-form'));
      
      // Make sure your function is named 'startShopping' in your script, 
      // or change this to 'initShopping' if that's what you used elsewhere.
      attach('startBtn', typeof startShopping !== 'undefined' ? startShopping : initShopping);
      
      attach('btn-finish', finishSchedule);
      attach('btn-confirm-swap', confirmSwap);
      
      const cancelSwap = document.getElementById('btn-cancel-swap');
      if(cancelSwap) cancelSwap.onclick = () => document.getElementById('swapModal').style.display='none';

      document.querySelectorAll('.tab-cat').forEach(tab => {
        tab.onclick = (e) => {
          document.querySelectorAll('.tab-cat').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
          renderCatalog(e.target.dataset.type);
        };
      });
  }

  function showView(id) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
  }


  // --- HELPER: Auto-Bold Labels, Links, and Line Breaks ---
  function formatDescription(text) {
      if (!text) return '';
      // 1. Auto-Bold logic
      let formatted = text.replace(/^((?!http)[^:\n]+):/gm, '<strong>$1</strong>:');
      // 2. Replace newlines with <br>
      formatted = formatted.replace(/\n/g, '<br>');
      // 3. Auto-link URLs
      formatted = formatted.replace(
          /(https?:\/\/[^\s]+)/g, 
          '<a href="$1" target="_blank" style="color:#D21F28; text-decoration:underline; font-weight:bold;">More Info</a>'
      );
      return formatted;
  }

  function populatePathways() {
    const sel = document.getElementById('pathwaySelect');
    sel.innerHTML = '<option value="" disabled selected>-- Select Your Path --</option>';
    schoolData.pathways.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
      sel.add(new Option(p.name, p.name));
    });
  }

  function renderExploreCards() {
      const grid = document.getElementById('cardGrid');
      grid.innerHTML = '';
      schoolData.pathways.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        
        // FIX: Use the formatter
        const descHtml = formatDescription(p.description);

        card.innerHTML = `
          <small style="color:#888; font-weight:700; text-transform:uppercase;">${p.category}</small>
          <h4 style="margin:8px 0; color:#333;">${p.name}</h4>
          <div class="desc-box" id="desc-${p.name.replace(/\s/g,'')}">
              <div style="font-size:12px; color:#666; line-height:1.5;">${descHtml}</div>
          </div>
          <button class="toggle-link" onclick="toggleD(this)">Read More +</button>
          <button class="btn btn-red" style="width:100%; padding:10px; font-size:12px;" onclick="chooseP('${p.name}')">Select Pathway</button>
        `;
        grid.appendChild(card);
      });
  }

  window.toggleD = (btn) => {
    const box = btn.previousElementSibling;
    const isExp = box.classList.toggle('expanded');
    btn.innerText = isExp ? "Show Less -" : "Read More +";
  };

  window.chooseP = (name) => {
    document.getElementById('pathwaySelect').value = name;
    showView('view-form');
  };

  function findC(name) {
    return schoolData.catalog.find(c => c.title.toLowerCase() === name.toLowerCase()) || { title: name, credits: 1.0, id: 'NA' };
  }

  function startShopping() {
    const g = document.getElementById('gradeSelect').value;
    const p = document.getElementById('pathwaySelect').value;
    const fn = document.getElementById('inputFName').value.trim();
    const ln = document.getElementById('inputLName').value.trim();
    const id = document.getElementById('inputID').value.trim();

    if(!g || !p || !fn || !ln || !id) return showModal("Required Fields", "Please complete all student profile information.");

    userState.grade = g; userState.pathway = p;
    
    // Core Logic
    if(g==="9") userState.cart.core = [findC("English I"), [findC("Oklahoma History"), findC("High School Essentials I")], findC("Physical Science"), findC("Algebra I")];
    else if(g==="10") userState.cart.core = [findC("English II"), [findC("World History"), findC("High School Essentials II")], findC("Geometry"), findC("Biology")];
    else if(g==="11") userState.cart.core = [findC("English III"), findC("US History"), findC("Algebra II"), findC("Chemistry")];
    else userState.cart.core = [findC("English IV"), [findC("American Government"), {title: "Open Elective", credits: 0.5, id:"open"}], findC("Algebra II")];

    document.getElementById('studentHeader').innerText = `${fn} ${ln} | Grade ${g}`;
    document.getElementById('senior-alert').style.display = g==="12" ? "block" : "none";
    renderCart();
    renderCatalog('pathway');
    showView('view-shopping');

    // Trigger Tour if first time
    if(!localStorage.getItem('mhs_tour_seen_v2')) { 
      const tour = new TourGuide([
        { target: '#coreSlots', title: 'Review Core Classes', text: 'These are your pre-assigned core courses.\n\nClick "Swap" to change levels (e.g. Regular to Accelerated).' },
        { target: '.tab-group', title: 'Choose Electives', text: 'Use these tabs to browse courses.\n\nREQUIREMENTS:\n• 1-2 Pathway Courses\n• Required Electives\n• General Electives' },
        { target: '#catalogList .slot:first-child', title: 'Add Your Courses', text: 'Browse list and click "+ ADD".\n\nYou must reach 7 Credits total, plus 2 Alternates.' },
        { target: '#btn-finish', title: 'Review & Submit', text: 'Once your "Credits" counter says 7/7, click here to finalize.' }
      ]);
      setTimeout(() => tour.start(), 500); 
    }
  }

  // Helper for absolute delete buttons
  function createSafeDeleteBtn(index, type) {
     const btn = document.createElement('span');
     btn.innerHTML = '&times;';
     btn.className = 'del-btn';
     btn.onclick = function() { 
       if(type === 'elective') remE(index);
       else remA(index);
     };
     return btn;
  }

  // --- RENDER CART (With Validation Hooks) ---
  function renderCart() {
    
    // 1. Calculate Total Credits
    let tot = 0;
    userState.cart.core.forEach(i => Array.isArray(i) ? tot+=i[0].credits+i[1].credits : tot+=i.credits);
    userState.cart.electives.forEach(c => tot+=c.credits);
    document.getElementById('slotCount').innerText = parseFloat(tot.toFixed(1)); // Fix decimal rounding

    // --- NEW BUTTON PULSE LOGIC ---
    const finishBtn = document.getElementById('btn-finish');
    if (finishBtn) {
        // Check if Credits are full AND Alternates are selected
        if (tot >= 7 && userState.cart.alternates.length >= 2) {
            finishBtn.classList.add('btn-ready');
            finishBtn.innerText = "Submit Schedule (Ready!)"; // Optional text change
        } else {
            finishBtn.classList.remove('btn-ready');
            finishBtn.innerText = "Review & Submit"; // Reset text
        }
    }

    // 2. Render CORE
    const cDiv = document.getElementById('coreSlots'); 
    cDiv.innerHTML='';
    userState.cart.core.forEach((item, i) => {
      const row = document.createElement('div');
      if(Array.isArray(item)) {
        row.innerHTML = `
            <div style="border-left: 4px solid #2196F3; background:white; border-bottom:1px solid #ddd;">
                <div class="split-header">Core ${i+1} (Semester Split)</div>
                <div class="cart-item">
                    <div><span class="cart-title">${item[0].title}</span></div>
                    <button class="btn-sm swap-btn-0">Swap</button>
                </div>
                <div class="cart-item" style="border-top:1px dashed #eee;">
                    <div><span class="cart-title">${item[1].title}</span></div>
                    ${item[1].type==='Placeholder' ? '' : '<button class="btn-sm swap-btn-1">Swap</button>'}
                </div>
            </div>`;
        row.querySelector('.swap-btn-0').onclick = function() { swapHonors(i, 0); };
        if(row.querySelector('.swap-btn-1')) row.querySelector('.swap-btn-1').onclick = function() { swapHonors(i, 1); };
      } else {
        row.innerHTML = `
            <div class="cart-item" style="border-left: 4px solid #4CAF50;">
                <div><span class="cart-label">Core ${i+1}</span><span class="cart-title">${item.title}</span></div>
                <button class="btn-sm swap-btn">Swap</button>
            </div>`;
        row.querySelector('.swap-btn').onclick = function() { swapHonors(i, -1); };
      }
      cDiv.appendChild(row);
    });

    // 3. Render ELECTIVES
    const eDiv = document.getElementById('flexSlots'); 
    eDiv.innerHTML='';
    const processed = new Set();
    let count=1;

    userState.cart.electives.forEach((c, idx) => {
      if(processed.has(idx)) return;
      const row = document.createElement('div');
      row.style.overflow = "visible"; 
      row.style.position = "relative";
      
      if(c.credits >= 1) {
        // Full Year
        row.innerHTML = `
            <div class="cart-item" style="border-left: 4px solid #FF9800; display: flex; align-items: center; justify-content: space-between;">
                <div><span class="cart-label">Elective ${count}</span><span class="cart-title">${c.title}</span></div>
            </div>`;
        row.querySelector('.cart-item').appendChild(createSafeDeleteBtn(idx, 'elective'));
        processed.add(idx);
      } else {
        // Semester Pair
        let partner = -1;
        for(let j=idx+1; j<userState.cart.electives.length; j++) {
            if(!processed.has(j) && userState.cart.electives[j].credits===0.5) { partner=j; break; }
        }

        const p1Title = c.title;
        // HOOK ADDED HERE: class='sem-empty'
        const p2Title = partner!==-1 ? userState.cart.electives[partner].title : "<span class='sem-empty' style='color:#ccc; font-style:italic;'>-- Select Semester 2 --</span>";

        row.innerHTML = `
            <div style="border-left: 4px solid #FF9800; background:white; border-bottom:1px solid #ddd;">
                <div class="split-header" style="background:#fff3e0; color:#e65100;">Elective ${count} (Semesters)</div>
                <div class="cart-item sem-top-container" style="display: flex; align-items: center; justify-content: space-between;">
                    <span class="cart-title">${p1Title}</span>
                </div>
                <div class="cart-item sem-bot-container" style="border-top:1px dashed #eee; display: flex; align-items: center; justify-content: space-between;">
                    <span class="cart-title">${p2Title}</span>
                </div>
            </div>`;

        row.querySelector('.sem-top-container').appendChild(createSafeDeleteBtn(idx, 'elective'));
        if(partner !== -1) row.querySelector('.sem-bot-container').appendChild(createSafeDeleteBtn(partner, 'elective'));
        
        processed.add(idx); 
        if(partner!==-1) processed.add(partner);
      }
      eDiv.appendChild(row);
      count++;
    });
    
    // 4. Render EMPTY Slots with HOOKS
    for(let k=0; k<Math.floor(7-tot); k++) {
        // HOOK ADDED HERE: class='target-shake'
        eDiv.innerHTML += `<div class="slot-empty target-shake">-- Open Elective Slot --</div>`;
    }
    
    // 5. Render ALTERNATES
    const aDiv = document.getElementById('altSlots'); 
    aDiv.innerHTML='';
    
    // A. Render Selected Alternates
    userState.cart.alternates.forEach((c,i) => {
        const d = document.createElement('div');
        d.innerHTML = `
            <div class="cart-item" style="background:#fff; display: flex; align-items: center; justify-content: space-between;">
                <div><span class="cart-label">Alternate ${i+1}</span><span class="cart-title">${c.title}</span></div>
            </div>`;
        d.querySelector('.cart-item').appendChild(createSafeDeleteBtn(i, 'alternate'));
        aDiv.appendChild(d);
    });

    // B. Render Empty Slots (Fill up to 2)
    const altCount = userState.cart.alternates.length;
    for(let k=0; k < (2 - altCount); k++) {
        // We add 'alt-empty' class here to target them for shaking later
        aDiv.innerHTML += `<div class="slot-empty alt-empty">-- Open Alternate Slot --</div>`;
    }

    // 6. Event Delegation Reset
    const newEDiv = eDiv.cloneNode(true);
    const newADiv = aDiv.cloneNode(true);
    eDiv.parentNode.replaceChild(newEDiv, eDiv);
    aDiv.parentNode.replaceChild(newADiv, aDiv);
    
    newEDiv.addEventListener('click', function(e) {
        const btn = e.target.closest('.del-btn');
        if (btn) {
            const idx = parseInt(btn.getAttribute('data-index'), 10);
            userState.cart.electives.splice(idx, 1);
            renderCart(); refreshCatalog();
        }
    });
    newADiv.addEventListener('click', function(e) {
        const btn = e.target.closest('.del-btn');
        if (btn) {
            const idx = parseInt(btn.getAttribute('data-index'), 10);
            userState.cart.alternates.splice(idx, 1);
            renderCart(); refreshCatalog();
        }
    });
  }

  window.remE = (i) => { userState.cart.electives.splice(i,1); renderCart(); renderCatalog(document.querySelector('.tab-cat.active').dataset.type); };
  window.remA = (i) => { userState.cart.alternates.splice(i,1); renderCart(); renderCatalog(document.querySelector('.tab-cat.active').dataset.type); };

  window.openSwap = (coreIndex, subIndex) => {
      // 1. Store the exact position being swapped
      pendingSwap = { coreIndex: coreIndex, subIndex: subIndex };

      // 2. Identify Subject based on the current title
      let currentTitle = "";
      if (subIndex === -1) {
          currentTitle = userState.cart.core[coreIndex].title;
      } else {
          currentTitle = userState.cart.core[coreIndex][subIndex].title;
      }
      
      // 3. Subject Detection Logic
      let subject = "";
      if (currentTitle.includes("English")) subject = "English";
      else if (currentTitle.match(/(Math|Algebra|Geometry|Calculus|Statistics)/)) subject = "Math";
      else if (currentTitle.match(/(Science|Biology|Chemistry|Physics|Zoology|Anatomy)/)) subject = "Science";
      else if (currentTitle.match(/(History|Government)/)) subject = "History";

      document.getElementById('swapSourceLabel').innerText = currentTitle;

      // 4. Populate the Select dropdown with allowed swaps for this grade/subject
      const allowedNames = ALLOWED_SWAPS[userState.grade][subject];
      const select = document.getElementById('swapTargetSelect');
      select.innerHTML = '<option value="">-- Select New Course --</option>';

      if (allowedNames) {
          allowedNames.forEach(name => {
              const realC = findC(name); // Uses the helper to find full object in catalog
              if (realC) {
                  const opt = document.createElement('option');
                  opt.value = realC.id;
                  opt.text = `${realC.title} (${realC.credits})`;
                  select.appendChild(opt);
              }
          });
      }
      document.getElementById('swapModal').style.display = 'flex';
  };

  // --- SWAP FUNCTIONS ---
  function swapHonors(coreIndex, subIndex) {
    // FIX 1: Use the correct variable name 'pendingSwap' to match your global declaration
    pendingSwap = { coreIndex: coreIndex, subIndex: subIndex };

    // 1. Identify Subject based on current title
    let currentTitle = "";
    if(subIndex === -1) currentTitle = userState.cart.core[coreIndex].title;
    else currentTitle = userState.cart.core[coreIndex][subIndex].title;
    
    // 2. Detect Subject
    let subject = "";
    if (currentTitle.includes("English")) subject = "English";
    else if (currentTitle.match(/(Math|Algebra|Geometry|Calculus|Statistics)/)) subject = "Math";
    else if (currentTitle.match(/(Science|Biology|Chemistry|Physics|Zoology|Anatomy)/)) subject = "Science";
    else if (currentTitle.match(/(History|Government)/)) subject = "History";
    
    // FIX 2: Explicitly handle "Essentials" so it knows to show History options
    if (currentTitle.includes("Essentials")) subject = "History";

    document.getElementById('swapSourceLabel').innerText = currentTitle;

    // 3. Populate Dropdown
    const allowedNames = ALLOWED_SWAPS[userState.grade][subject];
    const select = document.getElementById('swapTargetSelect');
    select.innerHTML = '<option value="">-- Select New Course --</option>';

    if (allowedNames) {
        allowedNames.forEach(name => {
            const realC = findC(name); 
            if(realC) {
                const opt = document.createElement('option');
                opt.value = realC.id;
                opt.text = `${realC.title} (${realC.credits})`;
                select.appendChild(opt);
            }
        });
    }
    document.getElementById('swapModal').style.display = 'flex';
  }


  function confirmSwap() {
      const newId = document.getElementById('swapTargetSelect').value;
      if (!newId) { 
          document.getElementById('swapModal').style.display = 'none'; 
          return; 
      }

      const newCourse = schoolData.catalog.find(c => String(c.id) === String(newId));
      if (!newCourse) return;

      // FIX 3: Read from 'pendingSwap' (which is now correctly populated)
      const p = pendingSwap; 
      
      // Safety check to prevent the crash if p is null
      if (!p) {
        console.error("Swap data missing");
        return;
      }

      // LOGIC: AP World (Year) replaces the whole slot (array becomes object)
      if (newCourse.title.includes("AP World History")) {
          userState.cart.core[p.coreIndex] = newCourse;
      } 
      // LOGIC: Swapping FROM AP World back to Standard (object becomes array)
      else if (p.subIndex === -1 && userState.cart.core[p.coreIndex].title.includes("AP World History")) {
          userState.cart.core[p.coreIndex] = [ newCourse, findC("High School Essentials II") ];
      }
      // LOGIC: Senior AP Government (Year) replaces split semester
      else if (newCourse.title.includes("AP US Government")) {
          userState.cart.core[p.coreIndex] = newCourse;
      }
      else if (p.subIndex === -1 && userState.cart.core[p.coreIndex].title.includes("AP US Government")) {
          userState.cart.core[p.coreIndex] = [ newCourse, { id: "open", title: "Open Elective", credits: 0.5 } ];
      }
      // STANDARD SWAP
      else {
          if (p.subIndex === -1) {
              userState.cart.core[p.coreIndex] = newCourse;
          } else {
              userState.cart.core[p.coreIndex][p.subIndex] = newCourse;
          }
      }

      renderCart();
      document.getElementById('swapModal').style.display = 'none';
  }

  function renderCatalog(type, btnEl) {
      if(btnEl) {
          document.querySelectorAll('.tab-cat').forEach(b => b.classList.remove('active'));
          btnEl.classList.add('active');
      }
      
      // --- SAFE ELEMENT SELECTION ---
      const box = document.getElementById('guidanceBox');
      const list = document.getElementById('catalogList'); 
      
      // If the list container is missing, we cannot render anything.
      if (!list) return;

      list.innerHTML = '';
      
      const myGrade = String(userState.grade);
      let courses = [];
      
      // 1. Filter the courses
      if(type==='pathway') {
        courses = schoolData.catalog.filter(c => {
            // Handle missing tags safely
            const tags = Array.isArray(c.pathway_tags) ? c.pathway_tags : [];
            // Loose equality check for grade (matches "10" to 10)
            const gradeMatch = c.grades.some(g => String(g) == myGrade);
            const tagMatch = tags.includes(userState.pathway);
            return gradeMatch && tagMatch;
        });

        // SAFE UPDATE: Only update guidance box if it exists
        if (box) {
            const count = userState.cart.electives.filter(c=>c.pathway_tags && c.pathway_tags.includes(userState.pathway)).length;
            box.innerHTML = count===0 ? "<strong>Guidance:</strong> Please select 1-2 classes from your pathway." : "<strong>Good job!</strong> You have pathway classes selected.";
            box.className = count===0 ? "guide warn" : "guide";
        }

      } else {
        // SAFE UPDATE: Only update guidance box if it exists
        if (box) {
            box.innerHTML = type==='required' ? "Required Electives (Arts, PE, Language)" : "General Electives";
            box.className = "guide";
        }

        const targetType = type==='required' ? "Required" : "General";
        courses = schoolData.catalog.filter(c => 
            c.type.includes(targetType) &&
            c.grades.some(g => String(g) == myGrade)
        );
      }

      // 2. Handle Empty Results
      if(courses.length === 0) {
          list.innerHTML = `<div style="padding:15px; color:#666; font-style:italic;">No courses available for Grade ${myGrade} in this category.</div>`;
          return;
      }

      // 3. Render Items
      courses.forEach(c => {
        const isAdd = userState.cart.electives.concat(userState.cart.alternates).find(x=>x.id==c.id);
        
        let creditLabel = c.credits === 0.5 ? "Semester" : (c.credits === 0 ? "Non-Credit" : "Year");
        let labelColor = c.credits === 0 ? "#fff3cd" : "#eee";

        let feeBadge = '';
        if (c.description && (c.description.includes("$") || /\bfee\b/i.test(c.description))) {
            feeBadge = `<span style="background:#d4edda; color:#155724; border:1px solid #c3e6cb; padding:2px 6px; border-radius:4px; font-weight:bold; margin-right:5px;">$ Fee</span>`;
        }

        let gradeDisplay = Array.isArray(c.grades) ? c.grades.join(', ') : c.grades;

        const div = document.createElement('div');
        div.className = 'slot';
        div.style.display = 'block';
        div.style.padding = '15px'; 
        div.style.borderBottom = '1px solid #eee';
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
              <div>
                  <strong style="color:#D21F28; font-size:15px;">${c.title}</strong>
                  <div style="font-size:11px; color:#666; margin-top:4px; display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                      <span style="background:${labelColor}; padding:2px 6px; border-radius:4px; font-weight:bold;">${creditLabel} (${c.credits})</span>
                      ${feeBadge}
                      <span>• Grades: ${gradeDisplay}</span>
                  </div>
              </div>
              ${isAdd ? '<span style="color:green; font-weight:bold; font-size:12px; margin-left:10px;">ADDED</span>' : 
                `<button class="btn-sm add-btn" style="background:#28a745; color:white; border:none; padding:6px 12px; margin-left:10px;">+ ADD</button>`}
            </div>
            <div style="font-size:13px; color:#444; margin-top:8px; line-height:1.4;">${c.description || ''}</div>
            <div style="font-size:11px; color:#856404; margin-top:6px; font-style:italic;">${c.prerequisite ? '<strong>Prereq:</strong> '+c.prerequisite : ''}</div>
        `;

        if(!isAdd) {
            div.querySelector('.add-btn').onclick = function() { add(c.id); };
        }
        list.appendChild(div);
      });
  }

  function add(id) {
      const c = schoolData.catalog.find(x => x.id == id);
      if (!c) return;

      const hasFee = (desc) => desc && (desc.includes("$") || /\bfee\b/i.test(desc));

      // Step 3: Performance add
      const performAdd = () => {
          let total = 0;
          userState.cart.core.forEach(item => {
              if (Array.isArray(item)) total += item[0].credits + item[1].credits;
              else total += item.credits;
          });
          userState.cart.electives.forEach(c => total += c.credits);

          if (total + c.credits <= 7.01) { // 7.01 to account for float math
              userState.cart.electives.push(c);
          } else if (userState.cart.alternates.length < 2) {
              showModal("Schedule Full", "Your 7 credits are full.<br>Adding this as an <strong>Alternate</strong>.", false);
              userState.cart.alternates.push(c);
          } else {
              showModal("Cart Full", "You have 7 Credits and 2 Alternates.<br>Please remove something first.", false);
              return;
          }
          renderCart(); 
          const activeBtn = document.querySelector('.tab-cat.active');
          if(activeBtn) renderCatalog(activeBtn.dataset.type, activeBtn);
      };

      // Step 2: Check Prereq
      const checkPrereq = () => {
          if (c.prerequisite && c.prerequisite.length > 2) {
              showModal("Prerequisite Check", `<strong>Course:</strong> ${c.title}<br><strong>Requires:</strong> ${c.prerequisite}<br><br>Have you met this requirement?`, true, performAdd);
          } else {
              performAdd();
          }
      };

      // Step 1: Check Fee
      if (hasFee(c.description)) {
          showModal("Course Fee Alert", `<strong>${c.title}</strong> requires an additional fee.<br>See description for details.<br><br>Do you accept this cost?`, true, checkPrereq);
      } else {
          checkPrereq();
      }
  }

  async function finishSchedule() {
    // 1. Calculate Totals
    let total = 0;
    userState.cart.core.forEach(i => total += Array.isArray(i) ? (i[0].credits + i[1].credits) : i.credits);
    userState.cart.electives.forEach(i => total += i.credits);
    const missing = 7 - total;

    // --- VALIDATION LOGIC ---
    let errorsFound = false;
    let msg = "";

    // Check 1: Credits < 7
    if(total < 7) {
        errorsFound = true;
        
        // ANIMATION: Shake Empty Slots
        document.querySelectorAll('.target-shake').forEach(el => {
            el.classList.add('error-shake');
            setTimeout(() => el.classList.remove('error-shake'), 600);
        });

        // ANIMATION: Red Text for Orphan Semesters
        document.querySelectorAll('.sem-empty').forEach(el => {
            el.classList.add('error-text');
            // We keep the red text on longer so they can find it
            setTimeout(() => el.classList.remove('error-text'), 2000); 
        });

        // Smart Message Generation
        msg += `You are missing <strong>${missing.toFixed(1)}</strong> credits.<br>`;
        if (missing % 1 !== 0) {
            msg += "<br>• You have an unmatched semester course (see red text).<br>• Please add another 0.5 credit elective.";
        } else {
            msg += "<br>• Please fill the empty slots blinking red.";
        }
    }

    // Check 2: Alternates < 2
    if(userState.cart.alternates.length < 2) {
        errorsFound = true;
        msg += (msg ? "<br><br>" : "") + `<strong>Alternates Missing:</strong><br>• You must select at least 2 alternates.<br>• Please fill the blinking slots.`;
        
        // NEW: Shake the specific empty alternate slots
        document.querySelectorAll('.alt-empty').forEach(el => {
            el.classList.add('error-shake');
            setTimeout(() => el.classList.remove('error-shake'), 600);
        });
    }

    if(errorsFound) {
        showModal("Incomplete Schedule", msg, false);
        return;
    }
    // ----------------------------

    const finishBtn = document.getElementById('btn-finish');
    finishBtn.innerText = "Submitting..."; finishBtn.disabled = true;

    // 2. Prepare Data Payload
    const simplify = (c) => ({ id: c.id, title: c.title, credits: c.credits });

    const studentData = {
      firstName: document.getElementById('inputFName').value,
      lastName:  document.getElementById('inputLName').value,
      studentId: document.getElementById('inputID').value,
      grade:     userState.grade,
      pathway:   userState.pathway,
      courses:   {
          core: userState.cart.core.map(item => Array.isArray(item) ? [simplify(item[0]), simplify(item[1])] : simplify(item)),
          electives: userState.cart.electives.map(simplify),
          alternates: userState.cart.alternates.map(simplify)
      }
    };

    const formData = new FormData();
    formData.append(FORM_FIELDS.firstName, studentData.firstName);
    formData.append(FORM_FIELDS.lastName, studentData.lastName);
    formData.append(FORM_FIELDS.studentId, studentData.studentId);
    formData.append(FORM_FIELDS.jsonData, JSON.stringify(studentData));

    // 3. Send with Retry Logic
    let attempt = 0, success = false;
    while(attempt < 3 && !success) {
      try {
        await fetch(GOOGLE_FORM_URL, { method: 'POST', mode: 'no-cors', body: formData });
        success = true;
      } catch(e) {
        attempt++;
        await new Promise(r => setTimeout(r, attempt * 1000));
      }
    }

    // 4. Handle Success/Failure
    if(success) {
      document.getElementById('receipt-data').innerHTML = `<strong>Student:</strong> ${studentData.firstName} ${studentData.lastName} (${studentData.studentId})<br><strong>Pathway:</strong> ${studentData.pathway}`;
      let list = '<ul>';
      userState.cart.core.forEach(i => list += `<li>Core: ${Array.isArray(i) ? i[0].title : i.title}</li>`);
      userState.cart.electives.forEach(i => list += `<li>Elective: ${i.title}</li>`);
      userState.cart.alternates.forEach(i => list += `<li>Alternate: ${i.title}</li>`);
      document.getElementById('receipt-list').innerHTML = list + '</ul>';
      document.getElementById('finishModal').style.display = 'flex';
    } else {
      showModal("Network Error", "Submission failed. Please try again.");
    }
    finishBtn.innerText = "Review & Submit"; finishBtn.disabled = false;
  }

  function showModal(title, text, isConfirm, yesCallback) {
    document.getElementById('msgTitle').innerText = title;
    document.getElementById('msgBody').innerHTML = text;
    
    const okBtn = document.getElementById('msgOkBtn');
    const cancelBtn = document.getElementById('msgCancelBtn');
    
    const newOk = okBtn.cloneNode(true);
    const newCancel = cancelBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOk, okBtn);
    cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

    document.getElementById('msgModal').style.display = 'flex';

    if(isConfirm) {
        newCancel.style.display = 'inline-block';
        newOk.innerText = "Yes, Proceed";
        newCancel.onclick = () => document.getElementById('msgModal').style.display='none';
        newOk.onclick = () => {
            document.getElementById('msgModal').style.display='none';
            if(yesCallback) yesCallback();
        };
    } else {
        newCancel.style.display = 'none';
        newOk.innerText = "OK";
        newOk.onclick = () => document.getElementById('msgModal').style.display='none';
    }
  }

  // Wait for DOM to be ready before running
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
})();


</script>

